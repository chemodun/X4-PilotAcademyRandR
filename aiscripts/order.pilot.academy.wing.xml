<?xml version="1.0" encoding="utf-8"?>
<aiscript name="order.pilot.academy.wing" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="1">
  <order id="PilotAcademyWing" name="{1972092412,101}" description="{1972092412,102}" category="trade" infinite="true" allowinloop="false">
    <params>
      <param name="wingId" type="internal" text="Wing ID" comment="Wing ID" default="''" />
      <param name="runMode" type="internal" text="Run Mode" comment="Run Mode" default="false" />
      <param name="debugchance" type="bool"
        default="if @player.entity.$pilotAcademyRAndRData.$debugLevel == 'debug' or @player.entity.$pilotAcademyRAndRData.$debugLevel == 'trace' then 100 else 0"
        advanced="true" text="{1041, 10086}" comment="Print debug output">
        <input_param name="truevalue" value="100" />
      </param>
    </params>
    <requires>
      <match shiptype="shiptype.lasertower" negate="true" />
      <match class="class.spacesuit" negate="true" />
    </requires>
  </order>
  <interrupts>
    <library>
      <actions name="PilotAcademyGetTargetRankLevel">
        <set_value name="$targetRankLevel" exact="3" />
        <set_value name="$commonData" exact="@player.entity.$pilotAcademyRAndRData" />
        <debug_text text="'Pilot Academy [%s]: loaded commonData: %s' . [this.assignedcontrolled.debugname, @$commonData]" chance="$debugchance" />
        <do_if value="@$commonData != null and @$commonData.$targetRankLevel != null">
          <set_value name="$targetRankLevel" exact="@$commonData.$targetRankLevel" />
        </do_if>
        <debug_text
          text="'Pilot Academy [%s]: determined targetRankLevel: %s' . [this.assignedcontrolled.debugname, $targetRankLevel]"
          chance="$debugchance" />
      </actions>
      <actions name="PilotAcademyProcessWingData">
        <set_value name="$wingData" exact="null" />
        <set_value name="$wingsData" exact="@player.entity.$pilotAcademyRAndRWings" />
        <do_if value="typeof $wingsData == datatype.table">
          <set_value name="$wingData" exact="@$wingsData.{'$%s'.[$wingId]}" />
        </do_if>
        <debug_text
          text="'Pilot Academy [%s]: loaded wingData: %s for wingId: %s from wingsData: %s' . [this.assignedcontrolled.debugname, @$wingData, @$wingId, @$wingsData]"
          chance="$debugchance" />
        <do_if value="@$wingData != null">
          <set_value name="$factionNames" exact="if @$wingData.$factions != null then @$wingData.$factions else []" />
          <set_value name="$primaryGoal" exact="if @$wingData.$primaryGoal != null then @$wingData.$primaryGoal else 'rank'" />
          <set_value name="$tradeInfoRefreshInterval"
            exact="if @$wingData.$refreshInterval != null then (@$wingData.$refreshInterval * 60)s else 1800s" />
          <debug_text
            text="'Pilot Academy [%s]: extracted from wingData: factionNames count: %s, primaryGoal: %s, tradeInfoRefreshInterval: %s' .
              [this.assignedcontrolled.debugname, $factionNames.count, $primaryGoal, $tradeInfoRefreshInterval]"
            chance="$debugchance" />
          <include_interrupt_actions ref="PilotAcademyGetTargetRankLevel" />
        </do_if>
        <do_else>
          <set_value name="$runMode" exact="false" />
        </do_else>
      </actions>
      <actions name="PilotAcademyInitShipVariables">
        <set_value name="$idCode" exact="this.assignedcontrolled.idcode" />
        <debug_text
          text="'Pilot Academy [%s]: pilotAcademyRAndRWingsInfo: %s' . [this.assignedcontrolled.debugname, @player.entity.$pilotAcademyRAndRWingsInfo]"
          chance="$debugchance" />
        <do_if value="not player.entity.$pilotAcademyRAndRWingsInfo? or @player.entity.$pilotAcademyRAndRWingsInfo == null">
          <set_value name="player.entity.$pilotAcademyRAndRWingsInfo" exact="table[]" />
        </do_if>
        <set_value name="$wingsInfo" exact="player.entity.$pilotAcademyRAndRWingsInfo" />
        <debug_text text="'Pilot Academy [%s]: loaded wingsInfo: %s' . [this.assignedcontrolled.debugname, @$wingsInfo]" chance="$debugchance" />
        <do_if value="not $wingsInfo.{'$%s'.[$wingId]}? or @$wingsInfo.{'$%s'.[$wingId]} == null">
          <set_value name="$wingsInfo.{'$%s'.[$wingId]}" exact="table[]" />
        </do_if>
        <set_value name="$shipsInfo" exact="$wingsInfo.{'$%s'.[$wingId]}" />
        <debug_text text="'Pilot Academy [%s]: loaded shipsInfo: %s' . [this.assignedcontrolled.debugname, @$shipsInfo]" chance="$debugchance" />
        <do_if value="not $shipsInfo.{'$%s'.[$idCode]}? or @$shipsInfo.{'$%s'.[$idCode]} == null">
          <set_value name="$shipsInfo.{'$%s'.[$idCode]}" exact="table[]" />
        </do_if>
        <set_value name="$shipInfo" exact="@$shipsInfo.{'$%s'.[$idCode]}" />
        <do_if value="not $shipInfo.$dataIsUpdated? or @$shipInfo.$dataIsUpdated == null">
          <set_value name="$shipInfo.$dataIsUpdated" exact="false" />
        </do_if>
        <debug_text
          text="'Pilot Academy [%s]: initialized shipInfo: %s, for idcode: %s.' . [this.assignedcontrolled.debugname, @$shipInfo, $idCode]"
          chance="$debugchance" />
        <remove_value name="$idCode" />
      </actions>
      <actions name="PilotAcademyRemoveShipVariables">
        <set_value name="$ship" exact="if @event.object == null then this.assignedcontrolled else @event.object" />
        <set_value name="$idCode" exact="$ship.idcode" />
        <do_if value="$shipsInfo? and @$shipsInfo!= null and $shipsInfo.{'$%s'.[$idCode]}? and @$shipsInfo.{'$%s'.[$idCode]} != null">
          <remove_value name="$shipsInfo.{'$%s'.[$idCode]}" />
          <debug_text
            text="'Pilot Academy [%s]: removed shipInfo for idcode: %s.' . [$ship, $idCode]"
            chance="$debugchance" />
        </do_if>
        <remove_value name="$idCode" />
        <remove_value name="$ship" />
      </actions>
      <actions name="PilotAcademyStoreCurrentShipInfo">
        <set_value name="$shipInfo.$tradeInfo"
          exact="table[
            $timeStamp = player.age,
            $tradeOperation = $tradeOperation,
            $selectedFaction = $selectedFaction,
            $selectedBuyOffer = $selectedBuyOffer,
            $selectedSellOffer = $selectedSellOffer,
            $lastTradeInfoRefresh = $lastTradeInfoRefresh
          ]" />
      </actions>
      <actions name="PilotAcademyResetCurrentTradeInfo">
        <include_interrupt_actions ref="PilotAcademyInitShipVariables" />
        <remove_value name="$shipInfo.$tradeInfo" />
        <set_value name="$selectedFaction" exact="null" />
        <set_value name="$selectedBuyOffer" exact="null" />
        <set_value name="$selectedSellOffer" exact="null" />
        <set_value name="$lastTradeInfoRefresh" exact="0s" />
      </actions>
      <actions name="PilotAcademyPrintStats">
        <debug_text
          text="'Pilot Academy [%s]: \nfaction %s relation: %s (%s)\npilot skills - combined: %s, Pilot: piloting %s, morale %s, management %s, engineering %s, boarding %s'.
            [this.assignedcontrolled.debugname, @$selectedFaction, @$selectedFaction.relationto.{faction.player}, @$selectedFaction.relation.{@$selectedFaction.relationto.{faction.player}}.uivalue, @this.combinedskill, @this.skill.{skilltype.piloting}, @this.skill.{skilltype.morale}, @this.skill.{skilltype.management}, @this.skill.{skilltype.engineering}, @this.skill.{skilltype.boarding}]"
          chance="$debugchance" />
      </actions>
      <actions name="PilotAcademyShareTradeInfo">
        <do_if value="@$shareInfoTarget != null and @$selectedFaction != null and @$selectedBuyOffer != null and @$selectedSellOffer != null">
          <signal_objects object="$shareInfoTarget" param="'PilotAcademyRAndR.TradeInfoDataUpdatedSignal'" param2="this.assignedcontrolled"
            param3="table[
              $selectedFaction = $selectedFaction,
              $selectedBuyOffer = $selectedBuyOffer,
              $selectedSellOffer = $selectedSellOffer
              ]"
            delay="300ms" />
          <debug_text
            text="'Pilot Academy [%s]: shared trade info with %s: faction %s, buy offer %s, sell offer %s'.[this.assignedcontrolled.debugname, $shareInfoTarget.debugname, @$selectedFaction.name, @$selectedBuyOffer.ware.id, @$selectedSellOffer.ware.id]"
            chance="$debugchance" />
        </do_if>
      </actions>
      <actions name="PilotAcademyReportRankUp">
        <do_if
          value="this.combinedskill ge $targetCombinedSkill and (not $shipInfo.$LastRankUpReportTime? or (player.age - $shipInfo.$LastRankUpReportTime) ge 180s)">
          <debug_text
            text="'Pilot Academy [%s]: Pilot %s reached target rank level %s with combined skill %s, reporting to Academy to request replacement.' .
              [this.assignedcontrolled.debugname, this.debugname, $targetRankLevel, this.combinedskill]"
            chance="$debugchance" />

          <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,1000001}.[this.name, $targetRankLevel]]" timeout="15s" />
          <do_if value="this.assignedcontrolled.people.free ge 1">
            <raise_lua_event name="'PilotAcademyRAndR.RankLevelReached'" param="this.assignedcontrolled" />
            <set_value name="$rankUpReported" exact="true" />
          </do_if>
          <do_else>
            <debug_text
              text="'Pilot Academy [%s]: Ship has no free crew capacity to perform rank up replacement!' .
                [this.assignedcontrolled.debugname]"
              chance="$debugchance" />
            <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,2000002}.[this.assignedcontrolled.name]]" priority="2" sound="notification_warning"
              timeout="15s" />
            <set_value name="$rankUpReported" exact="false" />
          </do_else>
          <include_interrupt_actions ref="PilotAcademyInitShipVariables" />
          <include_interrupt_actions ref="PilotAcademyStoreCurrentShipInfo" />
          <set_value name="$shipInfo.$LastRankUpReportTime" exact="player.age" />
        </do_if>
      </actions>
      <actions name="PilotAcademySearchForDemandOffers">
        <set_value name="$demandOffers" exact="null" />
        <do_if value="$offerType == 'buy'">
          <find_buy_offer tradepartner="this.assignedcontrolled" space="player.galaxy" result="$demandOffers" multiple="true">
            <totalvolume min="$tradeVolumeMin" />
            <match_buyer tradesknownto="this.owner" owner="$faction">
              <match_relation_to object="this.assignedcontrolled" relation="enemy" comparison="not" />
              <match_use_blacklist group="$blacklistGroup" type="blacklisttype.objectactivity" object="this.assignedcontrolled" />
              <match_use_blacklist group="$blacklistGroup" type="blacklisttype.sectoractivity" object="this.assignedcontrolled" />
              <match_use_blacklist group="$blacklistGroup" type="blacklisttype.sectortravel" object="this.assignedcontrolled" />
            </match_buyer>
          </find_buy_offer>
        </do_if>
        <do_else>
          <find_sell_offer tradepartner="this.assignedcontrolled" space="player.galaxy" result="$demandOffers" multiple="true">
            <totalvolume min="$tradeVolumeMin" />
            <match_seller tradesknownto="this.owner" owner="$faction">
              <match_relation_to object="this.assignedcontrolled" relation="enemy" comparison="not" />
              <match_use_blacklist group="$blacklistGroup" type="blacklisttype.objectactivity" object="this.assignedcontrolled" />
              <match_use_blacklist group="$blacklistGroup" type="blacklisttype.sectoractivity" object="this.assignedcontrolled" />
              <match_use_blacklist group="$blacklistGroup" type="blacklisttype.sectortravel" object="this.assignedcontrolled" />
            </match_seller>
          </find_sell_offer>
        </do_else>
        <debug_text
          text="'Pilot Academy [%s]: found %s %s offers from faction %s' . [this.assignedcontrolled.debugname, @$demandOffers.count, $offerType, @$faction.name]"
          chance="$debugchance" />
      </actions>
      <actions name="PilotAcademySearchForSupplyOffers">
        <set_value name="$supplyOffers" exact="null" />
        <do_if value="$offerType == 'buy'">
          <find_sell_offer tradepartner="this.assignedcontrolled" space="player.galaxy" result="$supplyOffers" wares="$demandOffer.ware"
            multiple="true">
            <totalvolume min="$tradeVolumeMin" />
            <match_seller tradesknownto="this.owner">
              <match_relation_to object="this.assignedcontrolled" relation="enemy" comparison="not" />
              <match_use_blacklist group="$blacklistGroup" type="blacklisttype.objectactivity" object="this.assignedcontrolled" />
              <match_use_blacklist group="$blacklistGroup" type="blacklisttype.sectoractivity" object="this.assignedcontrolled" />
              <match_use_blacklist group="$blacklistGroup" type="blacklisttype.sectortravel" object="this.assignedcontrolled" />
            </match_seller>
          </find_sell_offer>
        </do_if>
        <do_else>
          <find_buy_offer tradepartner="this.assignedcontrolled" space="player.galaxy" result="$supplyOffers" wares="$demandOffer.ware"
            multiple="true">
            <totalvolume min="$tradeVolumeMin" />
            <match_buyer tradesknownto="this.owner">
              <match_relation_to object="this.assignedcontrolled" relation="enemy" comparison="not" />
              <match_use_blacklist group="$blacklistGroup" type="blacklisttype.objectactivity" object="this.assignedcontrolled" />
              <match_use_blacklist group="$blacklistGroup" type="blacklisttype.sectoractivity" object="this.assignedcontrolled" />
              <match_use_blacklist group="$blacklistGroup" type="blacklisttype.sectortravel" object="this.assignedcontrolled" />
            </match_buyer>
          </find_buy_offer>
        </do_else>
        <debug_text
          text="'Pilot Academy [%s]: found %s opposite offers to %s of %s' . [this.assignedcontrolled.debugname, @$supplyOffers.count, $offerType, $demandOffer.ware.id]"
          chance="$debugchance" />
      </actions>
      <actions name="PilotAcademyDebugApply">
        <debug_text text="'Pilot Academy [%s]: Debug Apply interrupt actions invoked.' . [this.assignedcontrolled.debugname]" chance="$debugchance" />
        <do_if value="@$isInit == null or @$isInit != true">
          <set_value name="$debugchance" exact="0" />
          <do_if value="@$commonData.$debugLevel == 'debug' or @$commonData.$debugLevel == 'trace'">
            <set_value name="$debugchance" exact="100" />
            <debug_text
              text="'Pilot Academy [%s]: Debug level is %s, setting debug chance to %s.' . [this.assignedcontrolled.debugname, @$commonData.$debugLevel, $debugchance]"
              chance="$debugchance" />
          </do_if>
        </do_if>
      </actions>
    </library>
    <handler ref="AttackHandler" />
    <handler ref="MissileLockHandler" />
    <handler ref="ScannedHandler" />
    <handler ref="InspectedHandler" />
    <handler ref="FoundAbandonedHandler" />
    <handler ref="FoundLockboxHandler" />
    <handler ref="ResupplyHandler" />
    <handler ref="TideHandler" />
    <handler>
      <conditions>
        <event_object_signalled object="this.assignedcontrolled" param="'PilotAcademyRAndR.TradeInfoDataUpdatedSignal'"
          param2="this.assignedcontrolled.commander" />
        <check_value value="@event.param3 != null" />
        <check_value value="@event.param3.$selectedFaction != null" />
        <check_value value="@event.param3.$selectedBuyOffer != null" />
        <check_value value="@event.param3.$selectedSellOffer != null" />
      </conditions>
      <actions>
        <debug_text text="'Pilot Academy [%s]: received trade info update from commander %s'.[this.assignedcontrolled.debugname, event.param2.debugname]"
          chance="$debugchance" />
        <set_value name="$selectedFaction" exact="event.param3.$selectedFaction" />
        <set_value name="$selectedBuyOffer" exact="event.param3.$selectedBuyOffer" />
        <set_value name="$selectedSellOffer" exact="event.param3.$selectedSellOffer" />
        <abort_called_scripts resume="prepareTrade" />
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_signalled object="this.assignedcontrolled" param="'PilotAcademyRAndR.TradeInfoDataRequest'" />
        <check_value value="@event.param2 != null" />
        <check_value value="this.assignedcontrolled.subordinates.indexof.{@event.param2} gt 0" />
      </conditions>
      <actions>
        <debug_text text="'Pilot Academy [%s]: received trade info request from subordinate %s'.[this.assignedcontrolled.debugname, event.param2.debugname]"
          chance="$debugchance" />
        <do_if value="$tradeIsUnderPreparation">
          <debug_text text="'Pilot Academy [%s]: trade info is still under preparation, will not share info now'.[this.assignedcontrolled.debugname]"
            chance="$debugchance" />
        </do_if>
        <do_else>
          <set_value name="$shareInfoTarget" exact="event.param2" />
          <include_interrupt_actions ref="PilotAcademyShareTradeInfo" />
        </do_else>
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_player_subordinate_removed previous="this.assignedcontrolled" />
      </conditions>
      <actions>
        <include_interrupt_actions ref="PilotAcademyRemoveShipVariables" />
        <signal_objects object="player.entity" param="'AcademyPilotShipDeregisterRequest'" param2="event.object" />
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_signalled object="this.assignedcontrolled" param="'PilotAcademyRAndR.WingDataIsUpdatedSignal'" />
      </conditions>
      <actions>
        <debug_text text="'Pilot Academy [%s]: received data update notification' . [this.assignedcontrolled.debugname]" chance="$debugchance" />
        <include_interrupt_actions ref="PilotAcademyProcessWingData" />
        <do_if value="$isMovingToTradeTarget == true and $tradeOperation == 'buy'">
          <debug_text
            text="'Pilot Academy [%s]: interrupted while moving to trade target %s for buying, going to reset trades.' .
              [this.assignedcontrolled.debugname, $tradeTarget.debugname]"
            chance="$debugchance" />
          <set_value name="$isMovingToTradeTarget" exact="false" />
          <include_interrupt_actions ref="PilotAcademyResetCurrentTradeInfo" />
          <abort_called_scripts resume="prepareTrade" />
        </do_if>
        <do_else>
          <set_value name="$shipInfo.$dataIsUpdated" exact="true" />
        </do_else>
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_signalled object="this.assignedcontrolled" param="'PilotAcademyRAndR.DismissWingRequest'" />
      </conditions>
      <actions>
        <debug_text text="'Pilot Academy [%s]: received dismiss wing order, finishing.' . [this.assignedcontrolled.debugname]" chance="$debugchance" />
        <abort_called_scripts resume="finish" />
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_signalled object="this.assignedcontrolled" param="'PilotAcademyRAndR.RemoveFromWingRequest'" />
      </conditions>
      <actions>
        <debug_text text="'Pilot Academy [%s]: received remove from wing order, finishing.' . [this.assignedcontrolled.debugname]" chance="$debugchance" />
        <abort_called_scripts resume="finish" />
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_signalled object="player.entity" param="'PilotAcademyRAndR.TargetRankLevelChangedSignal'" />
      </conditions>
      <actions>
        <debug_text text="'Pilot Academy [%s]: received target rank level change notification' . [this.assignedcontrolled.debugname]" chance="$debugchance" />
        <include_interrupt_actions ref="PilotAcademyGetTargetRankLevel" />
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_signalled object="this.assignedcontrolled" param="'PilotAcademyRAndR.PrepareForPilotReplacementRequest'" />
        <check_value value="@event.param2 != null" />
      </conditions>
      <actions>
        <debug_text
          text="'Pilot Academy [%s]: preparing for pilot replacement by %s from %s.' . [this.assignedcontrolled.debugname, @event.param2.debugname, @event.param2.roleobject.debugname]"
          chance="$debugchance" />
        <set_value name="$replacementPilot" exact="@event.param2" />
        <abort_called_scripts resume="pilotReplacement" />
      </actions>
    </handler>
    <handler consume="false">
      <conditions>
        <event_object_signalled object="player.entity" param="'PilotAcademyRAndR.DebugLevelChangedSignal'" />
      </conditions>
      <actions>
        <debug_text
          text="'Pilot Academy [%s]: received debug level change notification' . [this.assignedcontrolled.debugname]"
          chance="$debugchance" />
        <include_interrupt_actions ref="PilotAcademyDebugApply" />
      </actions>
    </handler>
  </interrupts>
  <init>
    <set_value name="$isInit" exact="true" />
    <include_interrupt_actions ref="PilotAcademyDebugApply" />
    <debug_text
      text="'Pilot Academy [%s]: initialized order with wingId: %s, wingData: %s' .
        [this.assignedcontrolled.debugname, @$wingId, @$wingData]"
      chance="$debugchance" />
    <include_interrupt_actions ref="PilotAcademyProcessWingData" />
    <include_interrupt_actions ref="PilotAcademyInitShipVariables" />
    <set_value name="$enoughFactionsToCheck" exact="30" />
    <set_value name="$blacklistGroup" exact="blacklistgroup.civilian" />
    <set_value name="$tradeOfferTypes" exact="['buy', 'sell']" />
    <set_value name="$tradeRangeEnough" exact="10km" />
    <set_value name="$tradeVolumes" exact="[500000, 50000, 5000, 500, 50]" />
    <set_value name="$tradeOperation" exact="''" />
    <set_value name="$selectedFaction" exact="null" />
    <set_value name="$selectedBuyOffer" exact="null" />
    <set_value name="$selectedSellOffer" exact="null" />
    <set_value name="$targetCombinedSkill" exact="@$targetRankLevel * 20" />
    <set_value name="$tradeIsUnderPreparation" exact="false" />
    <set_value name="$isMovingToTradeTarget" exact="false" />
    <set_value name="$currentShip" exact="this.assignedcontrolled" />
    <set_value name="$rankUpReported" exact="false" />
    <set_value name="$lastTradeInfoRefresh" exact="0s" />
    <remove_value name="$isInit" />
  </init>
  <attention min="unknown">
    <actions>

      <do_if value="$runMode == false">
        <debug_text text="'Pilot Academy [%s]: order executed outside an Academy run, terminating.' . [this.assignedcontrolled.debugname]" chance="$debugchance" />
        <resume label="finish" />
      </do_if>

      <label name="prepareTrade" />
      <debug_text
        text="'Pilot Academy [%s]: check stored info in $shipInfo.$tradeInfo: %s, (%s, %s)'.[this.assignedcontrolled.debugname, @$shipInfo.$tradeInfo, $shipInfo.$tradeInfo?, $shipInfo.$tradeInfo.$timeStamp?]"
        chance="$debugchance" />
      <do_if value="$shipInfo.$tradeInfo? and $shipInfo.$tradeInfo.$timeStamp?">
        <set_value name="$lastTradeInfo" exact="$shipInfo.$tradeInfo" />
        <debug_text
          text="'Pilot Academy [%s]: found last trade info at %s ago: %s'.[this.assignedcontrolled.debugname, player.age - $lastTradeInfo.$timeStamp, $lastTradeInfo]"
          chance="$debugchance" />
        <do_if value="(player.age - $lastTradeInfo.$timeStamp) lt 180s">
          <set_value name="$tradeOperation" exact="$lastTradeInfo.$tradeOperation" />
          <set_value name="$selectedFaction" exact="$lastTradeInfo.$selectedFaction" />
          <set_value name="$selectedBuyOffer" exact="$lastTradeInfo.$selectedBuyOffer" />
          <set_value name="$selectedSellOffer" exact="$lastTradeInfo.$selectedSellOffer" />
          <set_value name="$lastTradeInfoRefresh" exact="$lastTradeInfo.$lastTradeInfoRefresh" />
          <debug_text
            text="'Pilot Academy [%s]: reusing last trade info from %s ago. Completed %s on %s.' . [this.assignedcontrolled.debugname, player.age - $lastTradeInfo.$timeStamp, $tradeOperation, if @$tradeOperation == 'sell' then @$selectedBuyOffer.owner.debugname else @$selectedSellOffer.owner.debugname]"
            chance="$debugchance" />
        </do_if>
        <remove_value name="$lastTradeInfo" />
        <remove_value name="$shipInfo.$tradeInfo" />
      </do_if>

      <do_if value="this.assignedcontrolled.tradeorders.count">
        <debug_text
          text="'Pilot Academy [%s]: waiting for %s outstanding trade(s)'.[this.assignedcontrolled.debugname, this.assignedcontrolled.tradeorders.count]"
          chance="$debugchance" />
        <wait min="5s" max="8s" />
        <resume label="prepareTrade" />
      </do_if>
      <debug_text
        text="'Pilot Academy [%s]: started with: targetRankLevel %s, factionsNames count %s, selectedFaction %s, selectedBuyOffer %s, selectedSellOffer %s'.
          [this.assignedcontrolled.debugname, $targetRankLevel, $factionNames.count, @$selectedFaction, @$selectedBuyOffer, @$selectedSellOffer]"
        chance="$debugchance" />
      <do_if value="@$selectedFaction == null or @$selectedBuyOffer == null or @$selectedSellOffer == null">

        <set_value name="$shipInfo.$dataIsUpdated" exact="false" />

        <do_if value="this.assignedcontrolled.commander != null">
          <debug_text
            text="'Pilot Academy [%s]: going to request parent %s for trade info' . [this.assignedcontrolled.debugname, this.assignedcontrolled.commander.debugname]"
            chance="$debugchance" />
          <resume label="waitInfoFromCommander" />
        </do_if>

        <set_value name="$tradeIsUnderPreparation" exact="true" />


        <set_command command="command.searchtrades" />

        <set_command_action commandaction="commandaction.searchingtrades" />
        <do_if value="this.assignedcontrolled.order" comment="Safety check in case the script is called from non-order script">
          <!-- Required for all infinite orders, no effect in case of finite timeout -->
          <set_order_syncpoint_reached order="this.assignedcontrolled.order" />
        </do_if>

        <get_factions_by_relation faction="faction.player" relation="neutral" result="$factionsListAll" />
        <get_factions_by_relation faction="faction.player" relation="friend" result="$friendFactions" />
        <append_list_elements name="$factionsListAll" other="$friendFactions" />
        <get_factions_by_tag result="$hiddenFactions" tag="tag.hidden" />
        <remove_from_list name="$factionsListAll" list="$hiddenFactions" />
        <remove_from_list name="$factionsListAll" exact="faction.player" />
        <debug_text
          text="'Pilot Academy [%s]: evaluating %s factions for trade opportunities. Selected factions count: %s' . [this.assignedcontrolled.debugname, $factionsListAll.count, $factionNames.count]"
          chance="$debugchance" />

        <create_list name="$filteredFactions" />
        <do_for_each name="$faction" in="$factionsListAll" counter="$i">

          <do_if value="not ($faction.isactive and $faction.knowntoplayer) or $faction.isvisitor">
            <debug_text
              text="'Pilot Academy [%s]: skipping faction %s due to inactive (%s) or unknown (%s)  or visitor (%s) status' . [this.assignedcontrolled.debugname, @$faction.name, not @$faction.isactive, not @$faction.knowntoplayer, @$faction.isvisitor]"
              chance="$debugchance" />
            <continue />
          </do_if>

          <do_if value="$faction.hasrelation.dock.{faction.player} == false">
            <debug_text text="'Pilot Academy [%s]: skipping faction %s due to no docking rights' . [this.assignedcontrolled.debugname, @$faction.name]"
              chance="$debugchance" />
            <continue />
          </do_if>

          <debug_text
            text="'Pilot Academy [%s]: faction Names count %s, evaluating faction id %s presence %s with relation %s' .
              [this.assignedcontrolled.debugname, @$factionNames.count, @$faction.id, @$factionNames.indexof.{$faction.id}, @$faction.relationto.{faction.player}]"
            chance="$debugchance" />

          <do_if value="$factionNames.count == 0">
            <append_to_list name="$filteredFactions" exact="$faction" />
          </do_if>
          <do_elseif value="$factionNames.indexof.{$faction.id} gt 0">
            <append_to_list name="$filteredFactions" exact="$faction" />
          </do_elseif>

          <do_if value="$i % 10 == 0">
            <wait min="1ms" max="3ms" />
          </do_if>

        </do_for_each>

        <sort_list list="$filteredFactions" sortbyvalue="loop.element.relationto.{faction.player}" sortdescending="false" />

        <debug_text
          text="'Pilot Academy [%s]: filtered factions count %s after filters to be processed for Primary Goal %s' .
          [this.assignedcontrolled.debugname, $filteredFactions.count, $primaryGoal]"
          chance="$debugchance" />

        <set_value name="$bestDistance" exact="-1" />
        <set_value name="$bestGateDistance" exact="999" />

        <set_value name="$tradeFound" exact="false" />
        <do_if value="$primaryGoal == 'rank'">
          <do_for_each name="$tradeVolumeMin" in="$tradeVolumes">
            <debug_text
              text="'Pilot Academy [%s]: evaluating trade volume tier %s on factions count %s' . [this.assignedcontrolled.debugname, $tradeVolumeMin, $filteredFactions.count]"
              chance="$debugchance" />
            <do_for_each name="$faction" in="$filteredFactions">
              <get_wares_illegal_to result="$illegalWares" faction="$faction" />
              <debug_text
                text="'Pilot Academy [%s]: evaluating faction %s with relation %s and illegal wares count: %s' . [this.assignedcontrolled.debugname, @$faction.name, @$faction.relationto.{faction.player}, $illegalWares.count]"
                chance="$debugchance" />

              <do_for_each name="$offerType" in="$tradeOfferTypes">

                <include_interrupt_actions ref="PilotAcademySearchForDemandOffers" />

                <do_if value="$demandOffers.count gt 0">

                  <sort_list list="$demandOffers" sortbyvalue="loop.element.amount" sortdescending="true" />

                  <do_for_each name="$demandOffer" in="$demandOffers" counter="$j">

                    <debug_text
                      text="'Pilot Academy [%s]: evaluating %s offer for %s of %s with volume %s from %s. Price %s, Quantity factor %s. Is illegal: %s' .
                      [this.assignedcontrolled.debugname, $offerType, $demandOffer.amount, $demandOffer.ware.id, $demandOffer.volume, $demandOffer.owner.debugname, $demandOffer.unitprice.formatted.default, $demandOffer.quantityfactor, $illegalWares.indexof.{$demandOffer.ware} gt 0]"
                      chance="$debugchance" />

                    <do_if value="$demandOffer.ware.waretransport != waretransport.container">
                      <continue />
                    </do_if>

                    <do_if value="$illegalWares.indexof.{$demandOffer.ware} gt 0">
                      <debug_text
                        text="'Pilot Academy [%s]: skipping %s offer for %s of %s as ware is illegal for faction %s' .
                        [this.assignedcontrolled.debugname, $offerType, $demandOffer.amount, $demandOffer.ware.id, $faction.name]"
                        chance="$debugchance" />
                      <continue />
                    </do_if>

                    <set_value name="$demandAmount" exact="$demandOffer.amount" />

                    <set_value name="$demandOwner" exact="$demandOffer.owner" />

                    <include_interrupt_actions ref="PilotAcademySearchForSupplyOffers" />

                    <do_if value="$supplyOffers.count == 0">
                      <debug_text
                        text="'Pilot Academy [%s]: no opposite offers to %s of %s, skipping' . [this.assignedcontrolled.debugname, $offerType, $demandOffer.ware.id]"
                        chance="$debugchance" />
                      <continue />
                    </do_if>

                    <sort_list list="$supplyOffers"
                      sortbyvalue="(if $demandOwner.gatedistance.{loop.element.owner}.{$blacklistGroup}.{this.assignedcontrolled} lt 0 then 999 else $demandOwner.gatedistance.{loop.element.owner}.{$blacklistGroup}.{this.assignedcontrolled})
                      * (if $demandOffer.owner.trueowner.id == loop.element.owner.trueowner.id then 1 else 2)"
                      sortdescending="false" />

                    <do_for_each name="$supplyOffer" in="$supplyOffers" counter="$k">


                      <get_wares_illegal_to result="$illegalWaresSupply" faction="$supplyOffer.owner.trueowner" />
                      <do_if value="$illegalWaresSupply.indexof.{$supplyOffer.ware} gt 0">
                        <debug_text
                          text="'Pilot Academy [%s]: skipping opposite offer for %s as ware is illegal for faction %s' .
                          [this.assignedcontrolled.debugname, $supplyOffer.ware.id, $supplyOffer.owner.trueowner.name]"
                          chance="$debugchance" />
                        <continue />
                      </do_if>

                      <set_value name="$distanceCoefficient" exact="if $demandOffer.owner.trueowner.id == $supplyOffer.owner.trueowner.id then 1 else 2" />
                      <set_value name="$gateDistance"
                        exact="$demandOwner.gatedistance.{$supplyOffer.owner}.{$blacklistGroup}.{this.assignedcontrolled} * $distanceCoefficient" />

                      <do_if value="$gateDistance lt 0">
                        <debug_text
                          text="'Pilot Academy [%s]: skipping all next opposite offers to %s of %s as no gate connection' . [this.assignedcontrolled.debugname, $offerType, $demandOffer.ware.id]"
                          chance="$debugchance" />
                        <break />
                      </do_if>

                      <set_value name="$tradeDistance" exact="$demandOwner.distanceto.{$supplyOffer.owner}* $distanceCoefficient" />
                      <debug_text
                        text="'Pilot Academy [%s]: gate distance for opposite offer for %s with volume %s from %s to %s of %s offer on %s is %s, best %s. Distance: %s, best %s. Distance coefficient: %s. Price %s, Quantity factor %s' .
                        [this.assignedcontrolled.debugname, $supplyOffer.amount, $supplyOffer.volume, $supplyOffer.owner.debugname, $offerType, $demandOffer.ware.id, $demandOwner.debugname, $gateDistance, $bestGateDistance, $tradeDistance, $bestDistance, $distanceCoefficient, $supplyOffer.unitprice.formatted.default, $supplyOffer.quantityfactor]"
                        chance="$debugchance" />
                      <do_if value="$bestGateDistance lt $gateDistance">
                        <debug_text
                          text="'Pilot Academy [%s]: skipping all next opposite offers to %s due to worse gate distance %s vs best %s' .
                        [this.assignedcontrolled.debugname, $offerType, $gateDistance, $bestGateDistance]"
                          chance="$debugchance" />
                        <break />
                      </do_if>

                      <set_value name="$supplyAmount" exact="$supplyOffer.amount" />


                      <do_if
                        value="$bestDistance == -1 or $bestGateDistance gt $gateDistance or $bestGateDistance == $gateDistance and $bestDistance gt $tradeDistance ">
                        <set_value name="$bestGateDistance" exact="$gateDistance" />
                        <set_value name="$bestDistance" exact="$tradeDistance" />
                        <set_value name="$selectedSellOffer" exact="if $offerType == 'buy' then $supplyOffer else $demandOffer" />
                        <set_value name="$selectedBuyOffer" exact="if $offerType == 'sell' then $supplyOffer else $demandOffer" />
                        <set_value name="$selectedFaction" exact="$faction" />
                        <debug_text
                          text="'Pilot Academy [%s]: new best pair of offers of %s found from %s to %s with distance %s, coefficient %s' .
                          [this.assignedcontrolled.debugname, $demandOwner.debugname, $demandOffer.ware.id, $supplyOffer.owner.debugname, $bestDistance, $distanceCoefficient]"
                          chance="$debugchance" />
                        <do_if value="$bestGateDistance == 0 and $bestDistance le $tradeRangeEnough">
                          <debug_text
                            text="'Pilot Academy [%s]: short enough distance %s (enough %s) and gate distance %s, stopping search for better trades'.
                          [this.assignedcontrolled.debugname, $bestDistance, $tradeRangeEnough, $bestGateDistance]"
                            chance="$debugchance" />
                          <set_value name="$tradeFound" exact="true" />
                        </do_if>
                      </do_if>

                      <remove_value name="$tradeDistance" />
                      <remove_value name="$gateDistance" />
                      <do_if value="$tradeFound">
                        <debug_text
                          text="'Pilot Academy [%s]: trade found, stopping evaluation of further opposite offers %s of %s' .
                          [this.assignedcontrolled.debugname, $offerType, $demandOffer.ware.id]"
                          chance="$debugchance" />
                        <break />
                      </do_if>
                      <do_if value="$k % 10 == 0">
                        <wait min="1ms" max="3ms" />
                      </do_if>
                    </do_for_each>

                    <remove_value name="$supplyOffers" />
                    <remove_value name="$supplyAmount" />
                    <do_if value="$tradeFound">
                      <debug_text
                        text="'Pilot Academy [%s]: trade found, stopping evaluation of further offers %s of %s' .
                      [this.assignedcontrolled.debugname, $offerType, $demandOffer.ware.id]"
                        chance="$debugchance" />
                      <break />
                    </do_if>
                    <do_if value="$j % 10 == 0">
                      <wait min="1ms" max="3ms" />
                    </do_if>
                  </do_for_each>

                </do_if>
                <remove_value name="$demandOffers" />
                <remove_value name="$demandOwner" />
                <remove_value name="$demandAmount" />
                <do_if value="$tradeFound">
                  <debug_text
                    text="'Pilot Academy [%s]: trade found, stopping evaluation of further offer types for faction %s' . [this.assignedcontrolled.debugname, @$faction.name]"
                    chance="$debugchance" />
                  <break />
                </do_if>
              </do_for_each>

              <do_if value="@$selectedFaction != null">
                <do_if value="$selectedSellOffer.owner.trueowner.id != $selectedBuyOffer.owner.trueowner.id">
                  <set_value name="$bestGateDistance" exact="$bestGateDistance / 2" />
                  <set_value name="$bestDistance" exact="$bestDistance / 2" />
                </do_if>
                <debug_text
                  text="'Pilot Academy [%s]: ----\ncurrent best offers pair for faction %s: sell ware %s from %s in amount %s and volume %s, price %s, quantity factor %s, buy on %s with amount %s and volume %s, price %s, quantity factor %s with distance %s and gate distance %s\n----'
                  .[this.assignedcontrolled.debugname, $selectedFaction, $selectedSellOffer.ware.id, $selectedSellOffer.owner.debugname, $selectedSellOffer.amount, $selectedSellOffer.volume, $selectedSellOffer.unitprice.formatted.default, $selectedSellOffer.quantityfactor, $selectedBuyOffer.owner.debugname, $selectedBuyOffer.amount, $selectedBuyOffer.volume, $selectedBuyOffer.unitprice.formatted.default, $selectedBuyOffer.quantityfactor, $bestDistance, $bestGateDistance]"
                  chance="$debugchance" />
              </do_if>
              <do_else>
                <debug_text text="'Pilot Academy [%s]: no qualifying trades found for faction %s' .[this.assignedcontrolled.debugname, @$faction.name]"
                  chance="$debugchance" />
              </do_else>

              <do_if value="$tradeFound">
                <debug_text text="'Pilot Academy [%s]: trade found, stopping evaluation of further factions'.[this.assignedcontrolled.debugname]"
                  chance="$debugchance" />
                <break />
              </do_if>
              <wait min="1ms" max="3ms" />
            </do_for_each>
            <do_if value="$tradeFound">
              <debug_text text="'Pilot Academy [%s]: trade found, stopping evaluation of further volumes and factions' .[this.assignedcontrolled.debugname]"
                chance="$debugchance" />
              <break />
            </do_if>
          </do_for_each>
        </do_if>
        <do_else>
          <do_for_each name="$faction" in="$filteredFactions">
            <get_wares_illegal_to result="$illegalWares" faction="$faction" />
            <debug_text
              text="'Pilot Academy [%s]: evaluating faction %s with relation %s and illegal wares count: %s' . [this.assignedcontrolled.debugname, @$faction.name, @$faction.relationto.{faction.player}, $illegalWares.count]"
              chance="$debugchance" />
            <do_for_each name="$tradeVolumeMin" in="$tradeVolumes">
              <debug_text
                text="'Pilot Academy [%s]: evaluating trade volume tier %ss' . [this.assignedcontrolled.debugname, $tradeVolumeMin]"
                chance="$debugchance" />

              <do_for_each name="$offerType" in="$tradeOfferTypes">

                <include_interrupt_actions ref="PilotAcademySearchForDemandOffers" />

                <do_if value="$demandOffers.count gt 0">

                  <sort_list list="$demandOffers" sortbyvalue="loop.element.amount" sortdescending="true" />

                  <do_for_each name="$demandOffer" in="$demandOffers" counter="$j">

                    <debug_text
                      text="'Pilot Academy [%s]: evaluating %s offer for %s of %s with volume %s from %s. Price %s, Quantity factor %s. Is illegal: %s' .
                      [this.assignedcontrolled.debugname, $offerType, $demandOffer.amount, $demandOffer.ware.id, $demandOffer.volume, $demandOffer.owner.debugname, $demandOffer.unitprice.formatted.default, $demandOffer.quantityfactor, $illegalWares.indexof.{$demandOffer.ware} gt 0]"
                      chance="$debugchance" />

                    <do_if value="$demandOffer.ware.waretransport != waretransport.container">
                      <continue />
                    </do_if>

                    <do_if value="$illegalWares.indexof.{$demandOffer.ware} gt 0">
                      <debug_text
                        text="'Pilot Academy [%s]: skipping %s offer for %s of %s as ware is illegal for faction %s' .
                        [this.assignedcontrolled.debugname, $offerType, $demandOffer.amount, $demandOffer.ware.id, $faction.name]"
                        chance="$debugchance" />
                      <continue />
                    </do_if>

                    <set_value name="$demandAmount" exact="$demandOffer.amount" />

                    <set_value name="$demandOwner" exact="$demandOffer.owner" />

                    <include_interrupt_actions ref="PilotAcademySearchForSupplyOffers" />

                    <do_if value="$supplyOffers.count == 0">
                      <debug_text
                        text="'Pilot Academy [%s]: no opposite offers to %s of %s, skipping' . [this.assignedcontrolled.debugname, $offerType, $demandOffer.ware.id]"
                        chance="$debugchance" />
                      <continue />
                    </do_if>

                    <sort_list list="$supplyOffers"
                      sortbyvalue="(if $demandOwner.gatedistance.{loop.element.owner}.{$blacklistGroup}.{this.assignedcontrolled} lt 0 then 999 else $demandOwner.gatedistance.{loop.element.owner}.{$blacklistGroup}.{this.assignedcontrolled})
                      * (if $demandOffer.owner.trueowner.id == loop.element.owner.trueowner.id then 1 else 2)"
                      sortdescending="false" />

                    <do_for_each name="$supplyOffer" in="$supplyOffers" counter="$k">

                      <get_wares_illegal_to result="$illegalWaresSupply" faction="$supplyOffer.owner.trueowner" />
                      <do_if value="$illegalWaresSupply.indexof.{$supplyOffer.ware} gt 0">
                        <debug_text
                          text="'Pilot Academy [%s]: skipping opposite offer for %s as ware is illegal for faction %s' .
                          [this.assignedcontrolled.debugname, $supplyOffer.ware.id, $supplyOffer.owner.trueowner.name]"
                          chance="$debugchance" />
                        <continue />
                      </do_if>

                      <set_value name="$distanceCoefficient" exact="if $demandOffer.owner.trueowner.id == $supplyOffer.owner.trueowner.id then 1 else 2" />
                      <set_value name="$gateDistance"
                        exact="$demandOwner.gatedistance.{$supplyOffer.owner}.{$blacklistGroup}.{this.assignedcontrolled} * $distanceCoefficient" />

                      <do_if value="$gateDistance lt 0">
                        <debug_text
                          text="'Pilot Academy [%s]: skipping all next opposite offers to %s of %s as no gate connection' . [this.assignedcontrolled.debugname, $offerType, $demandOffer.ware.id]"
                          chance="$debugchance" />
                        <break />
                      </do_if>

                      <set_value name="$tradeDistance" exact="$demandOwner.distanceto.{$supplyOffer.owner}* $distanceCoefficient" />
                      <debug_text
                        text="'Pilot Academy [%s]: gate distance for opposite offer for %s with volume %s from %s to %s of %s offer on %s is %s, best %s. Distance: %s, best %s. Distance coefficient: %s. Price %s, Quantity factor %s' .
                        [this.assignedcontrolled.debugname, $supplyOffer.amount, $supplyOffer.volume, $supplyOffer.owner.debugname, $offerType, $demandOffer.ware.id, $demandOwner.debugname, $gateDistance, $bestGateDistance, $tradeDistance, $bestDistance, $distanceCoefficient, $supplyOffer.unitprice.formatted.default, $supplyOffer.quantityfactor]"
                        chance="$debugchance" />
                      <do_if value="$bestGateDistance lt $gateDistance">
                        <debug_text
                          text="'Pilot Academy [%s]: skipping all next opposite offers to %s due to worse gate distance %s vs best %s' .
                        [this.assignedcontrolled.debugname, $offerType, $gateDistance, $bestGateDistance]"
                          chance="$debugchance" />
                        <break />
                      </do_if>

                      <set_value name="$supplyAmount" exact="$supplyOffer.amount" />


                      <do_if
                        value="$bestDistance == -1 or $bestGateDistance gt $gateDistance or $bestGateDistance == $gateDistance and $bestDistance gt $tradeDistance ">
                        <set_value name="$bestGateDistance" exact="$gateDistance" />
                        <set_value name="$bestDistance" exact="$tradeDistance" />
                        <set_value name="$selectedSellOffer" exact="if $offerType == 'buy' then $supplyOffer else $demandOffer" />
                        <set_value name="$selectedBuyOffer" exact="if $offerType == 'sell' then $supplyOffer else $demandOffer" />
                        <set_value name="$selectedFaction" exact="$faction" />
                        <debug_text
                          text="'Pilot Academy [%s]: new best pair of offers of %s found from %s to %s with distance %s, coefficient %s' .
                          [this.assignedcontrolled.debugname, $demandOwner.debugname, $demandOffer.ware.id, $supplyOffer.owner.debugname, $bestDistance, $distanceCoefficient]"
                          chance="$debugchance" />
                        <do_if value="$bestGateDistance == 0 and $bestDistance le $tradeRangeEnough">
                          <debug_text
                            text="'Pilot Academy [%s]: short enough distance %s (enough %s) and gate distance %s, stopping search for better trades'.
                          [this.assignedcontrolled.debugname, $bestDistance, $tradeRangeEnough, $bestGateDistance]"
                            chance="$debugchance" />
                          <set_value name="$tradeFound" exact="true" />
                        </do_if>
                      </do_if>

                      <remove_value name="$tradeDistance" />
                      <remove_value name="$gateDistance" />
                      <do_if value="$tradeFound">
                        <debug_text
                          text="'Pilot Academy [%s]: trade found, stopping evaluation of further opposite offers %s of %s' .
                          [this.assignedcontrolled.debugname, $offerType, $demandOffer.ware.id]"
                          chance="$debugchance" />
                        <break />
                      </do_if>
                      <do_if value="$k % 10 == 0">
                        <wait min="1ms" max="3ms" />
                      </do_if>
                    </do_for_each>

                    <remove_value name="$supplyOffers" />
                    <remove_value name="$supplyAmount" />
                    <do_if value="$tradeFound">
                      <debug_text
                        text="'Pilot Academy [%s]: trade found, stopping evaluation of further offers %s of %s' .
                      [this.assignedcontrolled.debugname, $offerType, $demandOffer.ware.id]"
                        chance="$debugchance" />
                      <break />
                    </do_if>
                    <do_if value="$j % 10 == 0">
                      <wait min="1ms" max="3ms" />
                    </do_if>
                  </do_for_each>

                </do_if>
                <remove_value name="$demandOffers" />
                <remove_value name="$demandOwner" />
                <remove_value name="$demandAmount" />
                <do_if value="$tradeFound">
                  <debug_text
                    text="'Pilot Academy [%s]: trade found, stopping evaluation of further offer types for faction %s' . [this.assignedcontrolled.debugname, @$faction.name]"
                    chance="$debugchance" />
                  <break />
                </do_if>
              </do_for_each>

              <do_if value="@$selectedFaction != null">
                <do_if value="$selectedSellOffer.owner.trueowner.id != $selectedBuyOffer.owner.trueowner.id">
                  <set_value name="$bestGateDistance" exact="$bestGateDistance / 2" />
                  <set_value name="$bestDistance" exact="$bestDistance / 2" />
                </do_if>
                <debug_text
                  text="'Pilot Academy [%s]: ----\ncurrent best offers pair for faction %s: sell ware %s from %s in amount %s and volume %s, price %s, quantity factor %s, buy on %s with amount %s and volume %s, price %s, quantity factor %s with distance %s and gate distance %s\n----'
                  .[this.assignedcontrolled.debugname, $selectedFaction, $selectedSellOffer.ware.id, $selectedSellOffer.owner.debugname, $selectedSellOffer.amount, $selectedSellOffer.volume, $selectedSellOffer.unitprice.formatted.default, $selectedSellOffer.quantityfactor, $selectedBuyOffer.owner.debugname, $selectedBuyOffer.amount, $selectedBuyOffer.volume, $selectedBuyOffer.unitprice.formatted.default, $selectedBuyOffer.quantityfactor, $bestDistance, $bestGateDistance]"
                  chance="$debugchance" />
              </do_if>
              <do_else>
                <debug_text text="'Pilot Academy [%s]: no qualifying trades found for faction %s' .[this.assignedcontrolled.debugname, @$faction.name]"
                  chance="$debugchance" />
              </do_else>

              <do_if value="$tradeFound">
                <debug_text text="'Pilot Academy [%s]: trade found, stopping evaluation of further volumes'.[this.assignedcontrolled.debugname]"
                  chance="$debugchance" />
                <break />
              </do_if>
              <wait min="1ms" max="3ms" />
            </do_for_each>
            <do_if value="@$selectedFaction != null and @$selectedBuyOffer != null and @$selectedSellOffer != null">
              <set_value name="$tradeFound" exact="true" />
            </do_if>
            <do_if value="$tradeFound">
              <debug_text text="'Pilot Academy [%s]: trade found, stopping evaluation of further factions' .[this.assignedcontrolled.debugname]"
                chance="$debugchance" />
              <break />
            </do_if>
          </do_for_each>
        </do_else>
        <do_if value="@$selectedFaction != null and @$selectedBuyOffer != null and @$selectedSellOffer != null">
          <set_value name="$tradeFound" exact="true" />
          <set_value name="$lastTradeInfoRefresh" exact="player.age" />
        </do_if>
        <do_if value="not $tradeFound">
          <debug_text text="'Pilot Academy [%s]: no qualifying trade found after evaluating all factions' .[this.assignedcontrolled.debugname]"
            chance="$debugchance" />
          <wait min="6s" max="10s" />
          <resume label="prepareTrade" />
        </do_if>
        <do_if value="$selectedSellOffer.owner == $selectedBuyOffer.owner">
          <debug_text
            text="'Pilot Academy [%s]: selected buy and sell offers have the same owner %s, going to find a ware with lowest price' .
              [this.assignedcontrolled.debugname, $selectedBuyOffer.owner.debugname]"
            chance="$debugchance" />
          <find_sell_offer tradepartner="this.assignedcontrolled" seller="$selectedSellOffer.owner" result="$localSellOffers" multiple="true">
            <amount min="$selectedSellOffer.amount / 2" />
          </find_sell_offer>
          <sort_list list="$localSellOffers" sortbyvalue="loop.element.unitprice" sortdescending="false" />
          <do_for_each name="$localSellOffer" in="$localSellOffers" counter="$i">
            <do_if value="$localSellOffer.ware.id == $selectedSellOffer.ware.id">
              <debug_text
                text="'Pilot Academy [%s]: skipping wares %s equal and after selected sell offer due to highest prices' .
                [this.assignedcontrolled.debugname, $localSellOffer.ware.id]"
                chance="$debugchance" />
              <break />
            </do_if>
            <debug_text
              text="'Pilot Academy [%s]: evaluating local sell offer for ware %s with amount %s and volume %s, price %s, quantity factor %s' .
                [this.assignedcontrolled.debugname, $localSellOffer.ware.id, $localSellOffer.amount, $localSellOffer.volume, $localSellOffer.unitprice.formatted.default, $localSellOffer.quantityfactor]"
              chance="$debugchance" />
            <find_buy_offer result="$matchingBuyOffers" tradepartner="this.assignedcontrolled" buyer="$selectedBuyOffer.owner" wares="$localSellOffer.ware"
              multiple="true">
              <amount min="$selectedBuyOffer.amount / 2" />
            </find_buy_offer>
            <do_if value="$matchingBuyOffers.count gt 0">
              <set_value name="$selectedSellOffer" exact="$localSellOffer" />
              <set_value name="$selectedBuyOffer" exact="$matchingBuyOffers.{1}" />
              <debug_text
                text="'Pilot Academy [%s]: ----\new best offers pair for faction %s: sell ware %s from %s in amount %s and volume %s, price %s, quantity factor %s, buy on %s with amount %s and volume %s, price %s, quantity factor %s with distance %s and gate distance %s\n----'
                  .[this.assignedcontrolled.debugname, $selectedFaction, $selectedSellOffer.ware.id, $selectedSellOffer.owner.debugname, $selectedSellOffer.amount, $selectedSellOffer.volume, $selectedSellOffer.unitprice.formatted.default, $selectedSellOffer.quantityfactor, $selectedBuyOffer.owner.debugname, $selectedBuyOffer.amount, $selectedBuyOffer.volume, $selectedBuyOffer.unitprice.formatted.default, $selectedBuyOffer.quantityfactor, $bestDistance, $bestGateDistance]"
                chance="$debugchance" />
            </do_if>
            <do_if value="$i % 10 == 0">
              <wait min="1ms" max="3ms" />
            </do_if>
          </do_for_each>
          <remove_value name="$localSellOffers" />
          <remove_value name="$matchingBuyOffers" />
        </do_if>
        <set_value name="$tradeIsUnderPreparation" exact="false" />
        <do_for_each name="$subordinate" in="this.assignedcontrolled.subordinates">
          <debug_text text="'Pilot Academy [%s]: going to share trade info with subordinate %s'.[this.assignedcontrolled.debugname, $subordinate.debugname]"
            chance="$debugchance" />
          <signal_objects object="$subordinate" param="'PilotAcademyRAndR.WingDataIsUpdatedSignal'" />
        </do_for_each>
      </do_if>
      <debug_text
        text="'Pilot Academy [%s]: selected trade from %s: sell ware %s from %s in amount %s and volume %s, price %s, quantity factor %s, buy on %s with amount %s and volume %s, price %s, quantity factor %s.'
          .[this.assignedcontrolled.debugname, $selectedFaction, $selectedSellOffer.ware.id, $selectedSellOffer.owner.debugname, $selectedSellOffer.amount, $selectedSellOffer.volume, $selectedSellOffer.unitprice.formatted.default, $selectedSellOffer.quantityfactor, $selectedBuyOffer.owner.debugname, $selectedBuyOffer.amount, $selectedBuyOffer.volume, $selectedBuyOffer.unitprice.formatted.default, $selectedBuyOffer.quantityfactor]"
        chance="$debugchance" />
      <label name="proceedWithTrade" />

      <debug_text text="'Pilot Academy [%s]: proceeding with trade operation %s'. [this.assignedcontrolled.debugname, @$tradeOperation]" chance="$debugchance" />

      <set_value name="$seller" exact="$selectedSellOffer.owner" />
      <set_value name="$buyer" exact="$selectedBuyOffer.owner" />

      <set_value name="$tradeAmountDefault" exact="1" />

      <do_if value="$tradeOperation == 'buy'">
        <debug_text
          text="'Pilot Academy [%s]: completed buying %s of %s from %s' . [this.assignedcontrolled.debugname, $tradeAmountDefault, $selectedSellOffer.ware.id, $seller.debugname]"
          chance="$debugchance" />
        <set_value name="$tradeTarget" exact="$buyer" />
        <set_value name="$targetType" exact="'buyer'" />
        <set_value name="$tradeOperation" exact="'sell'" />
        <set_value name="$tradeOffer" exact="$selectedBuyOffer" />
        <wait min="50ms" max="100ms" />
        <clamp_trade_amount trade="$selectedBuyOffer" amount="$tradeAmountDefault" buyer="$selectedBuyOffer.owner"
          seller="this.assignedcontrolled" result="$tradeAmount" />
      </do_if>
      <do_else>
        <do_if value="$tradeOperation == 'sell'">
          <debug_text
            text="'Pilot Academy [%s]: completed selling %s of %s to %s' . [this.assignedcontrolled.debugname, $tradeAmountDefault, $selectedBuyOffer.ware.id, $buyer.debugname]"
            chance="$debugchance" />
          <apply_experience entity="this" experience="'ship_trade_good'" factor="1" />
          <apply_experience object="this.assignedcontrolled" role="entityrole.service" experience="'ship_trade_good'" factor="1" />
          <do_if value="$shipInfo.$dataIsUpdated">
            <debug_text text="'Pilot Academy [%s]: data is updated, going to re-init trade cycle' . [this.assignedcontrolled.debugname]" chance="$debugchance" />
            <set_value name="$shipInfo.$dataIsUpdated" exact="false" />
            <include_interrupt_actions ref="PilotAcademyResetCurrentTradeInfo" />
            <resume label="prepareTrade" />
          </do_if>
        </do_if>
        <include_interrupt_actions ref="PilotAcademyPrintStats" />
        <include_interrupt_actions ref="PilotAcademyReportRankUp" />
        <do_if value="@$rankUpReported == true">
          <wait exact="600ms" />
        </do_if>
        <do_if value="this.assignedcontrolled.commander == null and (player.age - $lastTradeInfoRefresh) ge $tradeInfoRefreshInterval">
          <debug_text
            text="'Pilot Academy [%s]: there is wing commander and trade info is stale (last refresh at %s, current time %s, refresh interval %s)' .
            [this.assignedcontrolled.debugname, $lastTradeInfoRefresh, player.age, $tradeInfoRefreshInterval]"
            chance="$debugchance" />
          <include_interrupt_actions ref="PilotAcademyResetCurrentTradeInfo" />
          <resume label="prepareTrade" />
        </do_if>
        <set_value name="$tradeTarget" exact="$seller" />
        <set_value name="$targetType" exact="'seller'" />
        <set_value name="$tradeOperation" exact="'buy'" />
        <set_value name="$tradeOffer" exact="$selectedSellOffer" />
        <clamp_trade_amount trade="$selectedSellOffer" amount="$tradeAmountDefault" buyer="this.assignedcontrolled"
          seller="$selectedSellOffer.owner" result="$tradeAmount" />
      </do_else>


      <do_if value="$tradeAmount le 0">
        <debug_text
          text="'Pilot Academy [%s]: unable to clamp trade amount to %s on %s'.[this.assignedcontrolled.debugname, $tradeOperation, $tradeOffer.owner.debugname]"
          chance="$debugchance" />
        <wait min="500ms" max="1s" />
        <include_interrupt_actions ref="PilotAcademyResetCurrentTradeInfo" />
        <resume label="prepareTrade" />
      </do_if>

      <label name="moveTo" />
      <set_value name="$isMovingToTradeTarget" exact="true" />
      <do_if value="@this.assignedcontrolled.dock.container != $tradeTarget">
        <debug_text text="'Pilot Academy [%s]: moving to dock on %s %s' . [this.assignedcontrolled.debugname, $targetType, $tradeTarget.debugname]"
          chance="$debugchance" />
        <run_script name="'order.dock'">
          <param name="destination" value="$tradeTarget" />
          <param name="dockfollowers" value="false" />
          <param name="debugchance" value="$debugchance" />
        </run_script>
      </do_if>
      <do_if value="@this.assignedcontrolled.dock.container != $tradeTarget">
        <debug_text text="'Pilot Academy [%s]: still not reached %s %s' . [this.assignedcontrolled.debugname, $targetType, $tradeTarget.debugname]"
          chance="$debugchance" />
        <wait min="10ms" max="20ms" />
        <do_if value="$tradeTarget.owner.hasrelation.dock.{faction.player} == false">
          <debug_text
            text="'Pilot Academy [%s]: unable to dock on %s %s due to bad relations' . [this.assignedcontrolled.debugname, $targetType, $tradeTarget.debugname]"
            chance="$debugchance" />
          <include_interrupt_actions ref="PilotAcademyResetCurrentTradeInfo" />
          <resume label="prepareTrade" />
        </do_if>
        <resume label="moveTo" />
      </do_if>
      <set_value name="$isMovingToTradeTarget" exact="false" />
      <debug_text text="'Pilot Academy [%s]: reached %s %s' . [this.assignedcontrolled.debugname, $targetType, $tradeTarget.debugname]" chance="$debugchance" />

      <include_interrupt_actions ref="PilotAcademyInitShipVariables" />
      <include_interrupt_actions ref="PilotAcademyStoreCurrentShipInfo" />

      <debug_text
        text="'Pilot Academy [%s]: store info to $shipInfo.$tradeInfo: %s'.[this.assignedcontrolled.debugname, @$shipInfo.$tradeInfo]"
        chance="$debugchance" />

      <create_trade_order object="this.assignedcontrolled" tradeoffer="$tradeOffer" amount="$tradeAmount" immediate="true" internal="true" />
      <debug_text
        text="'Pilot Academy [%s]: proceed to %s %s of %s from %s'.[this.assignedcontrolled.debugname, $tradeOperation, $tradeAmount, $tradeOffer.ware.id, $tradeTarget.debugname]"
        chance="$debugchance" />

      <label name="waitForTradeCompletion" />
      <do_if value="this.assignedcontrolled.tradeorders.count">
        <debug_text
          text="'Pilot Academy [%s]: waiting for %s outstanding trade(s)'.[this.assignedcontrolled.debugname, this.assignedcontrolled.tradeorders.count]"
          chance="$debugchance" />
        <wait min="10ms" max="50ms" />
        <resume label="waitForTradeCompletion" />
      </do_if>
      <resume label="proceedWithTrade" />

      <label name="waitInfoFromCommander" />


      <set_command command="command.wait" />
      <set_command_action commandaction="commandaction.calculating" />
      <set_value name="$i" exact="[1,2,3,4,5].random" />
      <signal_objects object="this.assignedcontrolled.commander" param="'PilotAcademyRAndR.TradeInfoDataRequest'" param2="this.assignedcontrolled"
        delay="$i * 150ms" />
      <debug_text text="'Pilot Academy [%s]: request was sent, waiting now for trade info update from commander' . [this.assignedcontrolled.debugname]"
        chance="$debugchance" />
      <wait exact="60s">
        <interrupt>
          <conditions>
            <event_object_signalled object="this.assignedcontrolled" param="'PilotAcademyRAndR.WingDataIsUpdatedSignal'" />
          </conditions>
          <actions>
            <debug_text text="'Pilot Academy [%s]: received trade info update notification from commander' . [this.assignedcontrolled.debugname]"
              chance="$debugchance" />
            <resume label="prepareTrade" />
          </actions>
        </interrupt>
      </wait>
      <resume label="prepareTrade" />

      <label name="pilotReplacement" />
      <debug_text
        text="'Pilot Academy [%s]: pilot replacement requested at %s by %s' . [this.assignedcontrolled.debugname, player.age, @$replacementPilot.debugname]"
        chance="$debugchance" />
      <set_command command="command.wait" />
      <set_command_action commandaction="commandaction.standingby" />
      <do_if value="@$replacementPilot != null">
        <set_value name="$replacementPilotTemplate" exact="$replacementPilot.npctemplate" />
        <set_value name="$academyObject" exact="$replacementPilot.roleobject" />
        <debug_text
          text="'Pilot Academy [%s]: going to move the replacement pilot %s with template %s' .
            [this.assignedcontrolled.debugname, $replacementPilot.debugname, $replacementPilotTemplate]"
          chance="$debugchance" />
        <transfer_people result="$personTransferred" object="this.assignedcontrolled" otherobject="$academyObject"
          receiveworkforce="false">
          <existing_people people="[$replacementPilotTemplate]" />
        </transfer_people>
        <debug_text
          text="'Pilot Academy [%s]: Person transferred: Count: %s, Data: %s.'.
                            [ this.assignedcontrolled.debugname, $personTransferred.count, $personTransferred ]"
        />
        <do_if value="$personTransferred.count == 1">
          <debug_text
            text="'Pilot Academy [%s]: new pilot %s successfully transferred to %s. Going to swap with %s' .
            [this.assignedcontrolled.debugname, $replacementPilotTemplate, this.assignedcontrolled.debugname, this.debugname]"
            chance="$debugchance" />
          <signal_objects object="player.entity" param="'PilotAcademyRAndR.PilotSwapRequest'"
            param2="table[
              $ship = this.assignedcontrolled,
              $replacementPilotTemplate = $personTransferred.{1},
              $academyObject = $academyObject,
              $iteration =  0
            ]"
            delay="200ms" />
          <remove_value name="$replacementPilotTemplate" />
          <remove_value name="$replacementPilot" />
          <resume label="pilotReplacementWait" />
        </do_if>
        <remove_value name="$replacementPilotTemplate" />
      </do_if>
      <remove_value name="$replacementPilot" />
      <resume label="prepareTrade" />


      <label name="pilotReplacementWait" />

      <wait min="3s" max="5s" />
      <resume label="pilotReplacementWait" />

      <label name="finish" />
      <debug_text
        text="'Pilot Academy [%s]: finished order.pilot.academy.wing at %s. Subordinates count: %s' . [this.assignedcontrolled.debugname, player.age, @this.assignedcontrolled.subordinates.count]"
        chance="$debugchance" />
      <do_for_each name="$subordinate" in="this.assignedcontrolled.subordinates">
        <debug_text text="'Pilot Academy [%s]: going to dismiss subordinate %s'.[this.assignedcontrolled.debugname, $subordinate.debugname]"
          chance="$debugchance" />
        <signal_objects object="$subordinate" param="'PilotAcademyRAndR.DismissWingRequest'" />
      </do_for_each>
      <include_interrupt_actions ref="PilotAcademyRemoveShipVariables" />
      <remove_object_commander object="this.assignedcontrolled" />
      <signal_objects object="player.entity" param="'AcademyPilotShipDeregisterRequest'" param2="this.assignedcontrolled" />
      <create_order object="this.assignedcontrolled" id="'Wait'" default="true" />
    </actions>
  </attention>
  <on_abort>
    <debug_text text="'Pilot Academy [%s]: aborted order.pilot.academy.wing at %s' . [@$currentShip.debugname, player.age]" chance="$debugchance" />
  </on_abort>
</aiscript>