<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Pilot_Academy_Ranks_And_Relations" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <cues>
    <cue name="Main" version="1">
      <actions>
        <debug_text text="'Pilot Academy: Main'" chance="100" filter="scripts" />
        <set_value name="$debugchance" exact="0" />
        <include_actions ref="Prepare_Encyclopedia_Entries" />
      </actions>
      <cues>
        <cue name="On_Reload" instantiate="true" version="1">
          <conditions>
            <event_ui_triggered screen="'PilotAcademyRAndR'" control="'Reloaded'" />
          </conditions>
          <actions>
            <debug_text text="'Pilot Academy: On_Reload'" chance="$debugchance" filter="scripts" />
            <signal_cue_instantly cue="Reloaded" />
          </actions>
        </cue>

        <cue name="Reloaded" instantiate="true" version="1">
          <conditions>
            <event_cue_signalled />
          </conditions>
          <actions>
            <include_actions ref="Process_Debug_Level" />
            <debug_text text="'Pilot Academy: Reloaded. Data: %s. Wings: %s'. [@player.entity.$pilotAcademyRAndRData, @player.entity.$pilotAcademyRAndRWings]"
              chance="$debugchance" filter="scripts" />
          </actions>
        </cue>

        <cue name="Refresh_Pilot_Academy_Pilots" instantiate="true" checkinterval="180s" version="1">
          <actions>
            <debug_text text="'Pilot Academy: Refresh_Pilot_Academy_Pilots.'" chance="$debugchance" filter="scripts" />
            <raise_lua_event name="'PilotAcademyRAndR.RefreshPilots'" />
          </actions>
        </cue>

        <cue name="Process_Pilot_Swapping" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'PilotAcademyRAndR.PilotSwapRequest'" />
            <check_value value="@event.param2 != null" />
            <check_value value="typeof @event.param2 == datatype.table" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_Pilot_Swapping: Received swap request for %s pilots.' .
                [@event.param2]"
              chance="$debugchance" filter="scripts" />
            <set_value name="$ship" exact="@event.param2.$ship" />
            <set_value name="$shipName" exact="{1016,6}.[$ship.knownname, $ship.idcode]" />
            <set_value name="$replacementPilotTemplate" exact="@event.param2.$replacementPilotTemplate" />
            <set_value name="$replacementPilotName" exact="$ship.availablepeople.{$replacementPilotTemplate}.name" />
            <set_value name="$isCadet" exact="@event.param2.$isCadet" />
            <set_value name="$oldPilot" exact="$ship.aipilot" />
            <set_value name="$oldPilotName" exact="$oldPilot.name" />
            <set_value name="$oldPilotTemplate" exact="$oldPilot.npctemplate" />
            <set_value name="$academyObject" exact="@event.param2.$academyObject" />
            <set_value name="$iteration" exact="@event.param2.$iteration" />
            <assign_hired_actor actor="[$ship, $replacementPilotTemplate]" target="$ship"
              post="controlpost.aipilot" success="$pilotsSwappingResult" failed="$pilotsSwappingMessage" check="true" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Swapping: Swap Pilots Check: Iteration %s, Result: %s. Message: %s'.[$iteration, $pilotsSwappingResult, $pilotsSwappingMessage ]"
            />
            <do_if value="$pilotsSwappingResult">
              <debug_text
                text="'Pilot Academy: Process_Pilot_Swapping: pilot %s (%s) is can be replaced on %s by new pilot %s.' .
                  [$oldPilotName, $oldPilot.debugname, $ship.debugname, $replacementPilotName]"
                chance="$debugchance" />
              <assign_hired_actor actor="[$ship, $replacementPilotTemplate]" target="$ship"
                post="controlpost.aipilot" success="$pilotsSwappingResult" failed="$pilotsSwappingMessage" />
            </do_if>
            <do_if value="$pilotsSwappingResult">
              <debug_text
                text="'Pilot Academy: Process_Pilot_Swapping: pilot %s (%s) successfully assigned to %s, replacing %s.' .
                  [$replacementPilotName, $replacementPilotTemplate, $ship.debugname, $oldPilotName]"
                chance="$debugchance" />
              <signal_objects object="player.entity" param="'PilotAcademyRAndR.OldPilotReturnRequest'"
                param2="table[
                    $oldPilotTemplate = $oldPilotTemplate,
                    $ship = $ship,
                    $academyObject = $academyObject,
                    $iteration = 0
                  ]"
                delay="3s" />
              <set_value name="$messageTemplate" exact="if $isCadet then {1972092412,1000002} else {1972092412,1000007} " />
              <run_actions ref="Notify_Player">
                <param name="title" value="{1972092412,1}" />
                <param name="text" value="$messageTemplate.[$replacementPilotName, $shipName]" />
                <param name="object" value="$ship" />
              </run_actions>
              <remove_value name="$messageTemplate" />
            </do_if>
            <do_else>
              <debug_text
                text="'Pilot Academy: Process_Pilot_Swapping: failed to replace pilot %s on %s with new pilot %s (%s). Message: %s. Going to repeat.' .
                  [$oldPilotName, $ship.debugname, $replacementPilotName, $replacementPilotTemplate, $pilotsSwappingMessage]"
                chance="$debugchance" />
              <do_if value="$iteration le 5">
                <signal_objects object="player.entity" param="'PilotAcademyRAndR.PilotSwapRequest'"
                  param2="table[
                    $ship = $ship,
                    $replacementPilotTemplate = $replacementPilotTemplate,
                    $academyObject = $academyObject,
                    $isCadet = $isCadet,
                    $iteration = $iteration + 1
                  ]"
                  delay="200ms" />
              </do_if>
              <do_else>
                <debug_text
                  text="'Pilot Academy: Process_Pilot_Swapping: exceeded max attempts to swap pilot %s on %s. Please do it manually!' .
                    [$oldPilotName, $ship.debugname]"
                  chance="$debugchance" />
                <run_actions ref="Notify_Player">
                  <param name="title" value="{1972092412,1}" />
                  <param name="text" value="{1972092412,2000003}.[ $shipName ]" />
                  <param name="isWarning" value="true" />
                  <param name="object" value="$ship" />
                </run_actions>
              </do_else>
            </do_else>
            <remove_value name="$iteration" />
            <remove_value name="$replacementPilotTemplate" />
            <remove_value name="$replacementPilotName" />
            <remove_value name="$oldPilotName" />
            <remove_value name="$oldPilot" />
            <remove_value name="$oldPilotTemplate" />
            <remove_value name="$academyObject" />
            <remove_value name="$pilotsSwappingMessage" />
            <remove_value name="$pilotsSwappingResult" />
            <remove_value name="$ship" />
            <remove_value name="$shipName" />
          </actions>
        </cue>

        <cue name="Process_Old_Pilot_Return" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'PilotAcademyRAndR.OldPilotReturnRequest'" />
            <check_value value="@event.param2 != null" />
            <check_value value="typeof @event.param2 == datatype.table" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_Old_Pilot_Return: Received old pilot return request: %s.' .
                [@event.param2]"
              chance="$debugchance" filter="scripts" />
            <set_value name="$ship" exact="@event.param2.$ship" />
            <set_value name="$oldPilotTemplate" exact="@event.param2.$oldPilotTemplate" />
            <set_value name="$oldPilotName" exact="$ship.availablepeople.{$oldPilotTemplate}.name" />
            <set_value name="$academyObject" exact="@event.param2.$academyObject" />
            <set_value name="$iteration" exact="@event.param2.$iteration" />
            <set_value name="$academyFreeCapacity" exact="$academyObject.people.free" />
            <set_value name="$commonData" exact="@player.entity.$pilotAcademyRAndRData" />
            <set_value name="$targetRankLevel" exact="@$commonData.$targetRankLevel" />
            <set_value name="$targetCombinedSkill" exact="@$targetRankLevel * 20" />
            <set_npc_template_role template="$oldPilotTemplate" object="$ship" role="entityrole.trainee_group" />
            <debug_text
              text="'Pilot Academy: Process_Old_Pilot_Return: Iteration %s. Going to move old one %s (%s) to Academy: %s. Free capacity: %s. Target rank: %s (%s).' .
                  [$iteration, $oldPilotName, $oldPilotTemplate, $academyObject.debugname, $academyFreeCapacity, $targetRankLevel, $targetCombinedSkill]"
              chance="$debugchance" />
            <do_if value="$academyFreeCapacity gt 0">
              <set_value name="$oldPilotSkill" exact="$ship.availablepeople.{$oldPilotTemplate}.potentialskill.{controlpost.aipilot}" />
              <transfer_people result="$personTransferred" object="$academyObject" otherobject="$ship"
                receiveworkforce="false">
                <existing_people people="[$oldPilotTemplate]" />
              </transfer_people>
              <do_if value="$personTransferred.count == 1">
                <debug_text
                  text="'Pilot Academy: Process_Old_Pilot_Return: old pilot %s (%s) with skill %s successfully transferred to %s.' .
                      [$oldPilotName, $oldPilotTemplate, $oldPilotSkill, $academyObject.debugname]"
                  chance="$debugchance" />
                <do_if value="$oldPilotSkill ge $targetCombinedSkill">
                  <run_actions ref="Notify_Player">
                    <param name="title" value="{1972092412,1}" />
                    <param name="text" value="{1972092412,1000003}.[$oldPilotName]" />
                    <param name="object" value="$academyObject" />
                  </run_actions>
                </do_if>
                <do_else>
                  <run_actions ref="Notify_Player">
                    <param name="title" value="{1972092412,1}" />
                    <param name="text" value="{1972092412,1000006}.[$oldPilotName]" />
                    <param name="object" value="$academyObject" />
                  </run_actions>
                </do_else>
                <raise_lua_event name="'PilotAcademyRAndR.PilotReturned'" param="'%s'.[$personTransferred.{1}]" />
                <remove_value name="$oldPilotSkill" />
              </do_if>
              <do_else>
                <do_if value="$iteration le 5">
                  <debug_text
                    text="'Pilot Academy: Process_Old_Pilot_Return: failed to transfer old pilot %s (%s) to %s. Going to repeat.' .
                      [$oldPilotName, $oldPilotTemplate, $academyObject.debugname]"
                    chance="$debugchance" />
                  <signal_objects object="player.entity" param="'PilotAcademyRAndR.OldPilotReturnRequest'"
                    param2="table[
                    $oldPilotTemplate = $oldPilotTemplate,
                    $ship = $ship,
                    $academyObject = $academyObject,
                    $iteration = $iteration + 1
                  ]"
                    delay="3s" />
                </do_if>
                <do_else>
                  <debug_text
                    text="'Pilot Academy: Process_Old_Pilot_Return: exceeded max attempts to return old pilot %s (%s) to %s. Please do it manually!' .
                          [$oldPilotName, $oldPilotTemplate, $academyObject.debugname]"
                    chance="$debugchance" />
                  <run_actions ref="Notify_Player">
                    <param name="title" value="{1972092412,1}" />
                    <param name="text" value="{1972092412,2000004}.[$oldPilotName]" />
                    <param name="isWarning" value="true" />
                    <param name="object" value="$ship" />
                  </run_actions>
                </do_else>
              </do_else>
            </do_if>
            <do_else>
              <debug_text
                text="'Pilot Academy: Process_Old_Pilot_Return: no free capacity in Academy %s to return old pilot %s (%s).' .
                  [$academyObject.debugname, $oldPilotName, $oldPilotTemplate]"
                chance="$debugchance" />
              <run_actions ref="Notify_Player">
                <param name="title" value="{1972092412,1}" />
                <param name="text" value="{1972092412,2000005}.[$oldPilotName]" />
                <param name="isWarning" value="true" />
                <param name="object" value="$ship" />
              </run_actions>
            </do_else>
            <remove_value name="$iteration" />
            <remove_value name="$oldPilotName" />
            <remove_value name="$oldPilotTemplate" />
            <remove_value name="$ship" />
            <remove_value name="$academyObject" />
            <remove_value name="$personTransferred" />
            <remove_value name="$academyFreeCapacity" />
            <remove_value name="$commonData" />
            <remove_value name="$targetRankLevel" />
            <remove_value name="$targetCombinedSkill" />
          </actions>
        </cue>

        <cue name="Process_Move_New_Pilot" instantiate="true" version="2">
          <conditions>
            <event_object_signalled object="player.entity" param="'PilotAcademyRAndR.MoveNewPilotRequest'" />
            <check_value value="@event.param2 != null" />
            <check_value value="typeof @event.param2 == datatype.table" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_Move_New_Pilot: Received new pilot move request: %s.' .
                [@event.param2]"
              chance="$debugchance" filter="scripts" />
            <set_value name="$ship" exact="@event.param2.$ship" />
            <set_value name="$shipName" exact="{1016,6}.[$ship.knownname, $ship.idcode]" />
            <set_value name="$newPilotTemplate" exact="@event.param2.$newPilotTemplate" />
            <do_if value="@event.param2.$newPilot != null">
              <set_value name="$newPilotTemplate" exact="@event.param2.$newPilot.npctemplate" />
            </do_if>
            <set_value name="$academyObject" exact="@event.param2.$academyObject" />
            <set_value name="$newPilotName" exact="$academyObject.availablepeople.{$newPilotTemplate}.name" />
            <set_value name="$iteration" exact="@event.param2.$iteration" />
            <debug_text
              text="'Pilot Academy: Process_Move_New_Pilot: Iteration %s. Going to move new pilot %s (%s) to %s. Free capacity: %s.' .
                  [$iteration, $newPilotName, $newPilotTemplate, $shipName, @$ship.people.free]"
              chance="$debugchance" />
            <include_actions ref="Fire_Least_Skilled_Crew_Member" />
            <do_if value="@$ship.people.free gt 0">
              <transfer_people result="$personTransferred" object="$ship" otherobject="$academyObject"
                receiveworkforce="false">
                <existing_people people="[$newPilotTemplate]" />
              </transfer_people>
              <do_if value="$personTransferred.count == 1">
                <debug_text
                  text="'Pilot Academy: Process_Move_New_Pilot: new pilot %s (%s) successfully transferred to %s. Initiating pilot swap.' .
                      [$newPilotName, $newPilotTemplate, $ship.debugname]"
                  chance="$debugchance" />
                <run_actions ref="Notify_Player">
                  <param name="title" value="{1972092412,1}" />
                  <param name="text" value="{1972092412,1000005}.[$newPilotName, $shipName]" />
                  <param name="object" value="$ship" />
                </run_actions>
                <signal_objects object="player.entity" param="'PilotAcademyRAndR.PilotSwapRequest'"
                  param2="table[
                    $ship = $ship,
                    $replacementPilotTemplate = $personTransferred.{1},
                    $academyObject = $academyObject,
                    $isCadet = false,
                    $iteration = 0
                  ]"
                  delay="200ms" />
              </do_if>
              <do_else>
                <do_if value="$iteration le 5">
                  <debug_text
                    text="'Pilot Academy: Process_Move_New_Pilot: failed to transfer new pilot %s (%s) to %s. Going to repeat.' .
                      [$newPilotName, $newPilotTemplate, $shipName]"
                    chance="$debugchance" />
                  <signal_objects object="player.entity" param="'PilotAcademyRAndR.MoveNewPilotRequest'"
                    param2="table[
                    $newPilotTemplate = $newPilotTemplate,
                    $ship = $ship,
                    $academyObject = $academyObject,
                    $iteration = $iteration + 1
                  ]"
                    delay="500ms" />
                </do_if>
                <do_else>
                  <debug_text
                    text="'Pilot Academy: Process_Move_New_Pilot: exceeded max attempts to transfer new pilot %s (%s) to %s. Please do it manually!' .
                          [$newPilotName, $newPilotTemplate, $ship.debugname]"
                    chance="$debugchance" />
                  <run_actions ref="Notify_Player">
                    <param name="title" value="{1972092412,1}" />
                    <param name="text" value="{1972092412,2000006}.[$shipName, $newPilotName]" />
                    <param name="isWarning" value="true" />
                    <param name="object" value="$ship" />
                  </run_actions>
                </do_else>
              </do_else>
            </do_if>
            <do_else>
              <debug_text
                text="'Pilot Academy: Process_Move_New_Pilot: no free capacity on ship %s to move new pilot %s (%s).' .
                  [$ship.debugname, $newPilotName, $newPilotTemplate]"
                chance="$debugchance" />
              <run_actions ref="Notify_Player">
                <param name="title" value="{1972092412,1}" />
                <param name="text" value="{1972092412,2000002}.[$shipName]" />
                <param name="isWarning" value="true" />
                <param name="object" value="$ship" />
              </run_actions>
            </do_else>
            <remove_value name="$iteration" />
            <remove_value name="$newPilotName" />
            <remove_value name="$newPilotTemplate" />
            <remove_value name="$ship" />
            <remove_value name="$shipName" />
            <remove_value name="$academyObject" />
            <remove_value name="$personTransferred" />
          </actions>
        </cue>


        <cue name="Process_No_Cadets_Available" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'PilotAcademyRAndR.NoCadetsAvailableInfo'" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_No_Cadets_Available: No cadets available in Academy.'"
              chance="$debugchance" filter="scripts" />
            <run_actions ref="Notify_Player">
              <param name="title" value="{1972092412,1}" />
              <param name="text" value="{1972092412,2000001}" />
              <param name="isWarning" value="true" />
              <param name="object" value="@player.entity.$pilotAcademyRAndRData.$academyObject" />
            </run_actions>
          </actions>
        </cue>

        <cue name="Process_Wing_Is_Broken" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'PilotAcademyRAndR.WingIsBrokenInfo'" />
            <check_value value="@event.param2 != null" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_Wing_Is_Broken: Received info about broken wing: %s, with leader: %s.' .
                [@event.param2, @event.param3.debugname]"
              chance="$debugchance" filter="scripts" />
            <set_value name="$ship" exact="@event.param3" />
            <set_value name="$shipName" exact="{1016,6}.[$ship.knownname, $ship.idcode]" />
            <run_actions ref="Notify_Player">
              <param name="title" value="{1972092412,1}" />
              <param name="text" value="{1972092412,2000007}.[@event.param2, $shipName]" />
              <param name="isWarning" value="true" />
              <param name="object" value="$ship" />
            </run_actions>
          </actions>
        </cue>

        <cue name="Process_Pilot_Auto_Hire" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'PilotAcademyRAndR.CadetAutoHireRequest'" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Received auto-hire request. At: %s (%s). Factions: %s.' .
                [@event.param2.debugname, @event.param2, @event.param3]"
              chance="$debugchance" filter="scripts" />
            <set_value name="$ship" exact="@event.param2" />
            <set_value name="$factionNames" exact="@event.param3" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Ship is %s. Faction names filter: %s.' .
                [$ship.debugname, $factionNames]"
              chance="$debugchance" />
            <get_factions_by_relation faction="faction.player" relation="neutral" result="$factionsListAll" />
            <get_factions_by_relation faction="faction.player" relation="friend" result="$friendFactions" />
            <append_list_elements name="$factionsListAll" other="$friendFactions" />
            <get_factions_by_tag result="$hiddenFactions" tag="tag.hidden" />
            <remove_from_list name="$factionsListAll" list="$hiddenFactions" />
            <remove_from_list name="$factionsListAll" exact="faction.player" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Factions available after relation and hidden filtering: %s, count: %s.' .
                [@$factionsListAll, @$factionsListAll.count]"
              chance="$debugchance" />
            <create_list name="$factionsListFiltered" />
            <do_if value="@$factionNames != null and $factionNames.count gt 0">
              <do_for_each name="$faction" in="$factionsListAll">
                <do_if value="$factionNames.indexof.{$faction.id} gt 0">
                  <append_to_list name="$factionsListFiltered" exact="$faction" />
                </do_if>
              </do_for_each>
            </do_if>
            <do_else>
              <append_list_elements name="$factionsListFiltered" other="$factionsListAll" />
            </do_else>
            <shuffle_list list="$factionsListFiltered" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Factions available after name filtering: %s, count: %s, first: %s.' .
                [@$factionsListFiltered, @$factionsListFiltered.count, @$factionsListFiltered.{1}]"
              chance="$debugchance" />
            <set_value name="$selectedFaction" exact="$factionsListFiltered.{1}" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Selected faction %s for new cadet on %s.' .
                [$selectedFaction.id, $ship.debugname]"
              chance="$debugchance" />
            <get_character_definition macro="$cadetMacro" faction="$selectedFaction" tags="tag.pilot" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Cadet macro is %s.' .
                [@$cadetMacro]"
              chance="$debugchance" />
            <create_npc_template object="$ship" role="entityrole.trainee_group" name="$cadetTemplate" macro="$cadetMacro" />
            <set_skill object="$ship" template="$cadetTemplate" type="skilltype.boarding" min="0" max="2" />
            <set_skill object="$ship" template="$cadetTemplate" type="skilltype.engineering" min="1" max="4" />
            <set_skill object="$ship" template="$cadetTemplate" type="skilltype.management" min="1" max="2" />
            <set_skill object="$ship" template="$cadetTemplate" type="skilltype.piloting" min="2" max="4" />
            <set_skill object="$ship" template="$cadetTemplate" type="skilltype.morale" min="2" max="4" />
            <set_value name="$combinedskill" exact="$ship.availablepeople.{$cadetTemplate}.potentialskill.{controlpost.aipilot}" />
            <run_actions ref="md.NPC_Instantiation.HiringFeeFromCombinedSkill" result="$cadetHiringFee">
              <param name="combinedskill" value="$combinedskill" />
            </run_actions>
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Created new cadet %s (%s) on %s with hiring fee %s.' .
                [@$ship.availablepeople.{$cadetTemplate}.name, @$cadetTemplate, $ship.debugname, @$cadetHiringFee]"
              chance="$debugchance" />
            <reward_player money="-$cadetHiringFee" />
            <run_actions ref="Notify_Player">
              <param name="title" value="{1972092412,1}" />
              <param name="text" value="{1972092412,1000004}.[@$ship.availablepeople.{$cadetTemplate}.name, @$cadetHiringFee.formatted.default]" />
              <param name="object" value="$ship" />
              <param name="money" value="-$cadetHiringFee" />
            </run_actions>
            <set_value name="$commonData" exact="@player.entity.$pilotAcademyRAndRData" />
            <set_value name="$academyObject" exact="$commonData.$locationObject" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Academy object is %s.' .
                [$academyObject.debugname]"
              chance="$debugchance" />
            <signal_objects object="player.entity" param="'PilotAcademyRAndR.PilotSwapRequest'"
              param2="table[
                $ship = $ship,
                $replacementPilotTemplate = $cadetTemplate,
                $academyObject = $academyObject,
                $isCadet = true,
                $iteration = 0
              ]"
              delay="200ms" />
            <remove_value name="$cadetHiringFee" />
            <remove_value name="$cadetTemplate" />
            <remove_value name="$cadetMacro" />
            <remove_value name="$selectedFaction" />
            <remove_value name="$factionsListFiltered" />
            <remove_value name="$factionNames" />
            <remove_value name="$friendFactions" />
            <remove_value name="$factionsListAll" />
            <remove_value name="$academyObject" />
            <remove_value name="$combinedskill" />
            <remove_value name="$ship" />
          </actions>
        </cue>

        <cue name="Process_Pilot_Assigned" instantiate="true" version="1">
          <conditions>
            <event_player_assigned_hired_actor />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_Pilot_Assigned: actor: %s (%s), object: %s (%s), post or role: %s (type %s)' .
                [@event.param, @event.param.debugname, @event.param2, @event.param2.debugname, @event.param3, typeof @event.param3]"
              chance="$debugchance" filter="scripts" />
          </actions>
        </cue>

        <cue name="On_Debug_Level_Changed" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'PilotAcademyRAndR.DebugLevelChangedSignal'" />
          </conditions>
          <actions>
            <debug_text text="'Pilot Academy: On_Debug_Level_Changed'" chance="$debugchance" filter="scripts" />
            <include_actions ref="Process_Debug_Level" />
          </actions>
        </cue>

        <library name="Process_Debug_Level" purpose="include_actions" version="1">
          <actions>
            <set_value name="$commonData" exact="@player.entity.$pilotAcademyRAndRData" />
            <do_if value="@$commonData != null">
              <do_if value="@$commonData.$debugLevel == 'debug' or @$commonData.$debugLevel == 'trace'">
                <set_value name="$debugchance" exact="100" />
              </do_if>
              <do_else>
                <set_value name="$debugchance" exact="0" />
              </do_else>
            </do_if>
            <debug_text
              text="'Pilot Academy: Process_Debug_Level: Debug level is %s. Debug chance set to %s.' .
                [@$commonData.$debugLevel, $debugchance]"
              chance="100" filter="scripts" />
            <remove_value name="$commonData" />
          </actions>
        </library>

        <library name="Prepare_Encyclopedia_Entries" purpose="include_actions" version="1">
          <actions>
            <add_encyclopedia_entry type="researchables" item="'research_pilot_academy_r_and_r_wings_5'" />
            <add_encyclopedia_entry type="researchables" item="'research_pilot_academy_r_and_r_wings_9'" />
            <add_encyclopedia_entry type="researchables" item="'research_pilot_academy_r_and_r_auto_hire'" />
            <add_encyclopedia_entry type="researchables" item="'research_pilot_academy_r_and_r_auto_assign'" />
            <add_encyclopedia_entry type="researchables" item="'research_pilot_academy_r_and_r_3_star'" />
            <add_encyclopedia_entry type="researchables" item="'research_pilot_academy_r_and_r_4_star'" />
            <add_encyclopedia_entry type="researchables" item="'research_pilot_academy_r_and_r_5_star'" />
          </actions>
        </library>

        <library name="Notify_Player" purpose="run_actions" version="1">
          <params>
            <param name="title" />
            <param name="text" />
            <param name="isWarning" default="false" />
            <param name="object" />
            <param name="money" default="null" />
          </params>
          <actions>
            <debug_text
              text="'Pilot Academy: Notify_Player: Title: %s, Text: %s, IsWarning: %s, Object: %s, Money: %s. Notify: %s. LogBook: %s.'.
                [$title, $text, $isWarning, @$object.debugname, $money, @player.entity.$pilotAcademyRAndRData.$notificationsEnabled, @player.entity.$pilotAcademyRAndRData.$logbookEnabled]"
              chance="$debugchance" filter="scripts" />
            <do_if value="@player.entity.$pilotAcademyRAndRData.$notificationsEnabled == true">
              <do_if value="@$isWarning == true">
                <show_notification text="'%s\n%s'.[$title, $text]" priority="2" sound="notification_warning"
                  timeout="15s" />
              </do_if>
              <do_else>
                <show_notification text="'%s\n%s'.[$title, $text]" timeout="15s" />
              </do_else>
            </do_if>
            <do_if value="@player.entity.$pilotAcademyRAndRData.$logbookEnabled == true">
              <do_if value="@$money != null">
                <write_to_logbook category="general" title="$title" text="$text"
                  interaction="showonmap" object="$object" highlighted="@$isWarning == true" money="$money" />
              </do_if>
              <do_else>
                <write_to_logbook category="general" title="$title" text="$text"
                  interaction="showonmap" object="$object" highlighted="@$isWarning == true" />
              </do_else>
            </do_if>
          </actions>

        </library>

        <library name="Fire_Least_Skilled_Crew_Member" purpose="include_actions" version="1">
          <actions>
            <set_value name="$commonData" exact="@player.entity.$pilotAcademyRAndRData" />
            <debug_text
              text="'Pilot Academy: Fire_Least_Skilled_Crew_Member: Free crew slots: %s. Auto fire less skilled crew member setting: %s.' .
                  [$ship.people.free, @$commonData.$autoFireLessSkilledCrewMember]"
              chance="$debugchance" />
            <do_if value="$ship.people.free le 0 and @$commonData.$autoFireLessSkilledCrewMember == true">
              <debug_text
                text="'Pilot Academy: Fire_Least_Skilled_Crew_Member: no free crew slots to transfer replacement pilot. Going to fire lest skilled existing crew member'"
                chance="$debugchance" />
              <set_value name="$leastSkilledCrewMember" exact="null" />
              <set_value name="$leastSkill" exact="9999" />
              <do_for_each name="$crewMember" in="$ship.people.list" counter="$i">
                <set_value name="$crewMemberSkill" exact="$ship.people.{$crewMember}.skill.boarding + $ship.people.{$crewMember}.skill.engineering + $ship.people.{$crewMember}.skill.management + $ship.people.{$crewMember}.skill.morale + $ship.people.{$crewMember}.skill.piloting" />
                <do_if value="$crewMemberSkill lt $leastSkill">
                  <set_value name="$leastSkilledCrewMember" exact="$crewMember" />
                  <set_value name="$leastSkill" exact="$crewMemberSkill" />
                </do_if>
              </do_for_each>
              <do_if value="$leastSkilledCrewMember != null">
                <debug_text
                  text="'Pilot Academy: Fire_Least_Skilled_Crew_Member: firing least skilled crew member %s with skill %s to free up crew slot for replacement pilot' .
                   [$ship.people.{$leastSkilledCrewMember}.name, $leastSkill]"
                  chance="$debugchance" />
                <remove_npc_template object="$ship" template="$leastSkilledCrewMember" />
              </do_if>
              <remove_value name="$leastSkilledCrewMember" />
              <remove_value name="$leastSkill" />
            </do_if>
            <remove_value name="$commonData" />
          </actions>
        </library>

      </cues>
    </cue>
  </cues>
</mdscript>