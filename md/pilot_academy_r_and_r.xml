<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Pilot_Academy_Ranks_And_Relations" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <cues>
    <cue name="Main" version="2">
      <actions>
        <debug_text text="'Pilot Academy: Main'" chance="100" filter="scripts" />
        <set_value name="$debugchance" exact="100" />
      </actions>
      <patch sinceversion="2">
        <set_value name="$debugchance" exact="100" />
      </patch>
      <cues>
        <cue name="On_Reload" instantiate="true">
          <conditions>
            <event_ui_triggered screen="'PilotAcademyRAndR'" control="'Reloaded'" />
          </conditions>
          <actions>
            <debug_text text="'Pilot Academy: On_Reload'" chance="$debugchance" filter="scripts" />
            <signal_cue_instantly cue="Reloaded" />
          </actions>
        </cue>

        <cue name="Reloaded" instantiate="true" version="3">
          <conditions>
            <event_cue_signalled />
          </conditions>
          <actions>
            <debug_text text="'Pilot Academy: Reloaded. Data: %s. Wings: %s'. [@player.entity.$pilotAcademyRAndRData, @player.entity.$pilotAcademyRAndRWings]"
              chance="$debugchance" filter="scripts" />
          </actions>
        </cue>

        <cue name="Refresh_Pilot_Academy_Pilots" instantiate="true" checkinterval="300s">
          <actions>
            <debug_text text="'Pilot Academy: Refresh_Pilot_Academy_Pilots.'" chance="$debugchance" filter="scripts" />
          </actions>
        </cue>

        <cue name="Process_Report_Rank_Up" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'AcademyPilotRankUpReached'" />
            <check_value value="@event.param2 != null" />
            <check_value value="@event.param3 != null" />
            <check_value value="@event.param3.$timeStamp != null" />
            <check_value value="@event.param3.$targetRankLevel != null" />
            <check_value value="@event.param3.$selectedFaction != null" />
            <check_value value="@event.param3.$selectedBuyOffer != null" />
            <check_value value="@event.param3.$selectedSellOffer != null" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Report_Rank_Up: Pilot %s on %s is reached target rank %s at %s'.
                [@event.param2.pilot.debugname, @event.param2.debugname, @event.param3.$targetRankLevel, @event.param3.$timeStamp]"
              chance="$debugchance" filter="scripts" />
          </actions>
        </cue>

        <cue name="Process_Pilot_Swapping" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'AcademyPilotSwapRequest'" />
            <check_value value="@event.param2 != null" />
            <check_value value="typeof @event.param2 == datatype.table" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_Pilot_Swapping: Received swap request for %s pilots.' .
                [@event.param2]"
              chance="$debugchance" filter="scripts" />
            <set_value name="$ship" exact="@event.param2.$ship" />
            <set_value name="$shipName" exact="{1016,6}.[$ship.knownname, $ship.idcode]" />
            <set_value name="$replacementPilotTemplate" exact="@event.param2.$replacementPilotTemplate" />
            <set_value name="$replacementPilotName" exact="$ship.availablepeople.{$replacementPilotTemplate}.name" />
            <set_value name="$oldPilot" exact="$ship.aipilot" />
            <set_value name="$oldPilotName" exact="$oldPilot.name" />
            <set_value name="$oldPilotTemplate" exact="$oldPilot.npctemplate" />
            <set_value name="$academyObject" exact="@event.param2.$academyObject" />
            <set_value name="$iteration" exact="@event.param2.$iteration" />
            <assign_hired_actor actor="[$ship, $replacementPilotTemplate]" target="$ship"
              post="controlpost.aipilot" success="$pilotsSwappingResult" failed="$pilotsSwappingMessage" check="true" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Swapping: Swap Pilots Check: Iteration %s, Result: %s. Message: %s'.[$iteration, $pilotsSwappingResult, $pilotsSwappingMessage ]"
            />
            <do_if value="$pilotsSwappingResult">
              <debug_text
                text="'Pilot Academy: Process_Pilot_Swapping: pilot %s is can be replaced on %s by new pilot %s.' .
                  [$oldPilotName, $ship.debugname, $replacementPilotName]"
                chance="$debugchance" />
              <assign_hired_actor actor="[$ship, $replacementPilotTemplate]" target="$ship"
                post="controlpost.aipilot" success="$pilotsSwappingResult" failed="$pilotsSwappingMessage" />
            </do_if>
            <do_if value="$pilotsSwappingResult">
              <debug_text
                text="'Pilot Academy: Process_Pilot_Swapping: pilot %s (%s) successfully assigned to %s, replacing %s.' .
                  [$replacementPilotName, $replacementPilotTemplate, $ship.debugname, $oldPilotName]"
                chance="$debugchance" />
              <signal_objects object="player.entity" param="'AcademyOldPilotReturnRequest'"
                param2="table[
                    $oldPilotTemplate = $oldPilotTemplate,
                    $ship = $ship,
                    $academyObject = $academyObject,
                    $iteration = 0
                  ]"
                delay="500ms" />
              <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,1000002}.[$replacementPilotName, $shipName]]" timeout="15s" />
            </do_if>
            <do_else>
              <debug_text
                text="'Pilot Academy: Process_Pilot_Swapping: failed to replace pilot %s on %s with new pilot %s (%s). Message: %s. Going to repeat.' .
                  [$oldPilotName, $ship.debugname, $replacementPilotName, $replacementPilotTemplate, $pilotsSwappingMessage]"
                chance="$debugchance" />
              <do_if value="$iteration le 5">
                <signal_objects object="player.entity" param="'AcademyPilotSwapRequest'"
                  param2="table[
                    $ship = $ship,
                    $replacementPilotTemplate = $replacementPilotTemplate,
                    $academyObject = $academyObject,
                    $iteration = $iteration + 1
                  ]"
                  delay="200ms" />
              </do_if>
              <do_else>
                <debug_text
                  text="'Pilot Academy: Process_Pilot_Swapping: exceeded max attempts to swap pilot %s on %s. Please do it manually!' .
                    [$oldPilotName, $ship.debugname]"
                  chance="$debugchance" />

                <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,2000003}.[$shipName]]" priority="2" sound="notification_warning" timeout="15s" />
              </do_else>
            </do_else>
            <remove_value name="$iteration" />
            <remove_value name="$replacementPilotTemplate" />
            <remove_value name="$replacementPilotName" />
            <remove_value name="$oldPilotName" />
            <remove_value name="$oldPilot" />
            <remove_value name="$oldPilotTemplate" />
            <remove_value name="$academyObject" />
            <remove_value name="$pilotsSwappingMessage" />
            <remove_value name="$pilotsSwappingResult" />
            <remove_value name="$ship" />
            <remove_value name="$shipName" />
          </actions>
        </cue>

        <cue name="Process_Old_Pilot_Return" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'AcademyOldPilotReturnRequest'" />
            <check_value value="@event.param2 != null" />
            <check_value value="typeof @event.param2 == datatype.table" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_Old_Pilot_Return: Received old pilot return request: %s.' .
                [@event.param2]"
              chance="$debugchance" filter="scripts" />
            <set_value name="$ship" exact="@event.param2.$ship" />
            <set_value name="$oldPilotTemplate" exact="@event.param2.$oldPilotTemplate" />
            <set_value name="$oldPilotName" exact="$ship.availablepeople.{$oldPilotTemplate}.name" />
            <set_value name="$academyObject" exact="@event.param2.$academyObject" />
            <set_value name="$iteration" exact="@event.param2.$iteration" />
            <set_npc_template_role template="$oldPilotTemplate" object="$ship" role="entityrole.trainee_group" />
            <debug_text
              text="'Pilot Academy: Process_Old_Pilot_Return: Iteration %s. Going to move old one %s (%s) to Academy: %s.' .
                  [$iteration, $oldPilotName, $oldPilotTemplate, $academyObject.debugname]"
              chance="$debugchance" />
            <transfer_people result="$personTransferred" object="$academyObject" otherobject="$ship"
              receiveworkforce="false">
              <existing_people people="[$oldPilotTemplate]" />
            </transfer_people>
            <do_if value="$personTransferred.count == 1">
              <debug_text
                text="'Pilot Academy: Process_Old_Pilot_Return: old pilot %s (%s) successfully transferred to %s.' .
                      [$oldPilotName, $oldPilotTemplate, $academyObject.debugname]"
                chance="$debugchance" />
              <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,1000003}.[$oldPilotName]]" timeout="15s" />
            </do_if>
            <do_else>
              <do_if value="$iteration le 5">
                <debug_text
                  text="'Pilot Academy: Process_Old_Pilot_Return: failed to transfer old pilot %s (%s) to %s. Going to repeat.' .
                      [$oldPilotName, $oldPilotTemplate, $academyObject.debugname]"
                  chance="$debugchance" />
                <signal_objects object="player.entity" param="'AcademyOldPilotReturnRequest'"
                  param2="table[
                    $oldPilotTemplate = $oldPilotTemplate,
                    $ship = $ship,
                    $academyObject = $academyObject,
                    $iteration = $iteration + 1
                  ]"
                  delay="500ms" />
              </do_if>
              <do_else>
                <debug_text
                  text="'Pilot Academy: Process_Old_Pilot_Return: exceeded max attempts to return old pilot %s (%s) to %s. Please do it manually!' .
                          [$oldPilotName, $oldPilotTemplate, $academyObject.debugname]"
                  chance="$debugchance" />
                <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,2000004}.[$oldPilotName]]" priority="2" sound="notification_warning"
                  timeout="15s" />
              </do_else>
            </do_else>
            <remove_value name="$iteration" />
            <remove_value name="$oldPilotName" />
            <remove_value name="$oldPilotTemplate" />
            <remove_value name="$ship" />
            <remove_value name="$academyObject" />
            <remove_value name="$personTransferred" />
          </actions>
        </cue>

        <cue name="Process_No_Cadets_Available" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'AcademyNoCadetsAvailable'" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_No_Cadets_Available: No cadets available in Academy.'"
              chance="$debugchance" filter="scripts" />
            <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,2000001}]" priority="2" sound="notification_warning"
              timeout="15s" />
          </actions>
        </cue>

        <cue name="Process_ActorAssigned" instantiate="true" version="1">
          <conditions>
            <event_player_assigned_hired_actor />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_ActorAssigned: object: %s (%s), param: %s (%s), param2: %s (%s), param3: %s (%s).'.
                [@event.object, @event.object.debugname,
                @event.param, @event.param.debugname,
                @event.param2, @event.param2.debugname,
                @event.param3, @event.param3.debugname]"
              chance="$debugchance" filter="scripts" />
          </actions>
        </cue>

      </cues>
    </cue>
  </cues>
</mdscript>