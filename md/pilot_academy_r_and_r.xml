<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Pilot_Academy_Ranks_And_Relations" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <cues>
    <cue name="Main" version="2">
      <actions>
        <debug_text text="'Pilot Academy: Main'" chance="100" filter="scripts" />
        <set_value name="$debugchance" exact="100" />
      </actions>
      <patch sinceversion="2">
        <set_value name="$debugchance" exact="100" />
      </patch>
      <cues>
        <cue name="On_Reload" instantiate="true">
          <conditions>
            <event_ui_triggered screen="'PilotAcademyRAndR'" control="'Reloaded'" />
          </conditions>
          <actions>
            <debug_text text="'Pilot Academy: On_Reload'" chance="$debugchance" filter="scripts" />
            <signal_cue_instantly cue="Reloaded" />
          </actions>
        </cue>

        <cue name="Reloaded" instantiate="true" version="3">
          <conditions>
            <event_cue_signalled />
          </conditions>
          <actions>
            <debug_text text="'Pilot Academy: Reloaded. Data: %s. Wings: %s'. [@player.entity.$pilotAcademyRAndRData, @player.entity.$pilotAcademyRAndRWings]"
              chance="$debugchance" filter="scripts" />
          </actions>
        </cue>

        <cue name="Refresh_Pilot_Academy_Pilots" instantiate="true" checkinterval="180s">
          <actions>
            <debug_text text="'Pilot Academy: Refresh_Pilot_Academy_Pilots.'" chance="$debugchance" filter="scripts" />
            <raise_lua_event name="'PilotAcademyRAndR.RefreshPilots'" />
          </actions>
        </cue>

        <cue name="Process_Pilot_Swapping" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'AcademyPilotSwapRequest'" />
            <check_value value="@event.param2 != null" />
            <check_value value="typeof @event.param2 == datatype.table" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_Pilot_Swapping: Received swap request for %s pilots.' .
                [@event.param2]"
              chance="$debugchance" filter="scripts" />
            <set_value name="$ship" exact="@event.param2.$ship" />
            <set_value name="$shipName" exact="{1016,6}.[$ship.knownname, $ship.idcode]" />
            <set_value name="$replacementPilotTemplate" exact="@event.param2.$replacementPilotTemplate" />
            <set_value name="$replacementPilotName" exact="$ship.availablepeople.{$replacementPilotTemplate}.name" />
            <set_value name="$oldPilot" exact="$ship.aipilot" />
            <set_value name="$oldPilotName" exact="$oldPilot.name" />
            <set_value name="$oldPilotTemplate" exact="$oldPilot.npctemplate" />
            <set_value name="$academyObject" exact="@event.param2.$academyObject" />
            <set_value name="$iteration" exact="@event.param2.$iteration" />
            <assign_hired_actor actor="[$ship, $replacementPilotTemplate]" target="$ship"
              post="controlpost.aipilot" success="$pilotsSwappingResult" failed="$pilotsSwappingMessage" check="true" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Swapping: Swap Pilots Check: Iteration %s, Result: %s. Message: %s'.[$iteration, $pilotsSwappingResult, $pilotsSwappingMessage ]"
            />
            <do_if value="$pilotsSwappingResult">
              <debug_text
                text="'Pilot Academy: Process_Pilot_Swapping: pilot %s (%s) is can be replaced on %s by new pilot %s.' .
                  [$oldPilotName, $oldPilot.debugname, $ship.debugname, $replacementPilotName]"
                chance="$debugchance" />
              <assign_hired_actor actor="[$ship, $replacementPilotTemplate]" target="$ship"
                post="controlpost.aipilot" success="$pilotsSwappingResult" failed="$pilotsSwappingMessage" />
            </do_if>
            <do_if value="$pilotsSwappingResult">
              <debug_text
                text="'Pilot Academy: Process_Pilot_Swapping: pilot %s (%s) successfully assigned to %s, replacing %s.' .
                  [$replacementPilotName, $replacementPilotTemplate, $ship.debugname, $oldPilotName]"
                chance="$debugchance" />
              <signal_objects object="player.entity" param="'AcademyOldPilotReturnRequest'"
                param2="table[
                    $oldPilotTemplate = $oldPilotTemplate,
                    $ship = $ship,
                    $academyObject = $academyObject,
                    $iteration = 0
                  ]"
                delay="500ms" />
              <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,1000002}.[$replacementPilotName, $shipName]]" timeout="15s" />
            </do_if>
            <do_else>
              <debug_text
                text="'Pilot Academy: Process_Pilot_Swapping: failed to replace pilot %s on %s with new pilot %s (%s). Message: %s. Going to repeat.' .
                  [$oldPilotName, $ship.debugname, $replacementPilotName, $replacementPilotTemplate, $pilotsSwappingMessage]"
                chance="$debugchance" />
              <do_if value="$iteration le 5">
                <signal_objects object="player.entity" param="'AcademyPilotSwapRequest'"
                  param2="table[
                    $ship = $ship,
                    $replacementPilotTemplate = $replacementPilotTemplate,
                    $academyObject = $academyObject,
                    $iteration = $iteration + 1
                  ]"
                  delay="200ms" />
              </do_if>
              <do_else>
                <debug_text
                  text="'Pilot Academy: Process_Pilot_Swapping: exceeded max attempts to swap pilot %s on %s. Please do it manually!' .
                    [$oldPilotName, $ship.debugname]"
                  chance="$debugchance" />

                <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,2000003}.[$shipName]]" priority="2" sound="notification_warning" timeout="15s" />
              </do_else>
            </do_else>
            <remove_value name="$iteration" />
            <remove_value name="$replacementPilotTemplate" />
            <remove_value name="$replacementPilotName" />
            <remove_value name="$oldPilotName" />
            <remove_value name="$oldPilot" />
            <remove_value name="$oldPilotTemplate" />
            <remove_value name="$academyObject" />
            <remove_value name="$pilotsSwappingMessage" />
            <remove_value name="$pilotsSwappingResult" />
            <remove_value name="$ship" />
            <remove_value name="$shipName" />
          </actions>
        </cue>

        <cue name="Process_Old_Pilot_Return" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'AcademyOldPilotReturnRequest'" />
            <check_value value="@event.param2 != null" />
            <check_value value="typeof @event.param2 == datatype.table" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_Old_Pilot_Return: Received old pilot return request: %s.' .
                [@event.param2]"
              chance="$debugchance" filter="scripts" />
            <set_value name="$ship" exact="@event.param2.$ship" />
            <set_value name="$oldPilotTemplate" exact="@event.param2.$oldPilotTemplate" />
            <set_value name="$oldPilotName" exact="$ship.availablepeople.{$oldPilotTemplate}.name" />
            <set_value name="$academyObject" exact="@event.param2.$academyObject" />
            <set_value name="$iteration" exact="@event.param2.$iteration" />
            <set_value name="$academyFreeCapacity" exact="$academyObject.people.free" />
            <set_npc_template_role template="$oldPilotTemplate" object="$ship" role="entityrole.trainee_group" />
            <debug_text
              text="'Pilot Academy: Process_Old_Pilot_Return: Iteration %s. Going to move old one %s (%s) to Academy: %s. Free capacity: %s.' .
                  [$iteration, $oldPilotName, $oldPilotTemplate, $academyObject.debugname, $academyFreeCapacity]"
              chance="$debugchance" />
            <do_if value="$academyFreeCapacity gt 0">
              <transfer_people result="$personTransferred" object="$academyObject" otherobject="$ship"
                receiveworkforce="false">
                <existing_people people="[$oldPilotTemplate]" />
              </transfer_people>
              <do_if value="$personTransferred.count == 1">
                <debug_text
                  text="'Pilot Academy: Process_Old_Pilot_Return: old pilot %s (%s) successfully transferred to %s.' .
                      [$oldPilotName, $oldPilotTemplate, $academyObject.debugname]"
                  chance="$debugchance" />
                <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,1000003}.[$oldPilotName]]" timeout="15s" />
                <raise_lua_event name="'PilotAcademyRAndR.PilotReturned'" param="'%s'.[$personTransferred.{1}]" />
              </do_if>
              <do_else>
                <do_if value="$iteration le 5">
                  <debug_text
                    text="'Pilot Academy: Process_Old_Pilot_Return: failed to transfer old pilot %s (%s) to %s. Going to repeat.' .
                      [$oldPilotName, $oldPilotTemplate, $academyObject.debugname]"
                    chance="$debugchance" />
                  <signal_objects object="player.entity" param="'AcademyOldPilotReturnRequest'"
                    param2="table[
                    $oldPilotTemplate = $oldPilotTemplate,
                    $ship = $ship,
                    $academyObject = $academyObject,
                    $iteration = $iteration + 1
                  ]"
                    delay="500ms" />
                </do_if>
                <do_else>
                  <debug_text
                    text="'Pilot Academy: Process_Old_Pilot_Return: exceeded max attempts to return old pilot %s (%s) to %s. Please do it manually!' .
                          [$oldPilotName, $oldPilotTemplate, $academyObject.debugname]"
                    chance="$debugchance" />
                  <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,2000004}.[$oldPilotName]]" priority="2" sound="notification_warning"
                    timeout="15s" />
                </do_else>
              </do_else>
            </do_if>
            <do_else>
              <debug_text
                text="'Pilot Academy: Process_Old_Pilot_Return: no free capacity in Academy %s to return old pilot %s (%s).' .
                  [$academyObject.debugname, $oldPilotName, $oldPilotTemplate]"
                chance="$debugchance" />
              <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,2000005}.[$oldPilotName]]" priority="2" sound="notification_warning"
                timeout="15s" />
            </do_else>
            <remove_value name="$iteration" />
            <remove_value name="$oldPilotName" />
            <remove_value name="$oldPilotTemplate" />
            <remove_value name="$ship" />
            <remove_value name="$academyObject" />
            <remove_value name="$personTransferred" />
          </actions>
        </cue>

        <cue name="Process_Move_New_Pilot" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'AcademyMoveNewPilotRequest'" />
            <check_value value="@event.param2 != null" />
            <check_value value="typeof @event.param2 == datatype.table" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_Move_New_Pilot: Received new pilot move request: %s.' .
                [@event.param2]"
              chance="$debugchance" filter="scripts" />
            <set_value name="$ship" exact="@event.param2.$ship" />
            <set_value name="$shipName" exact="{1016,6}.[$ship.knownname, $ship.idcode]" />
            <set_value name="$newPilotTemplate" exact="@event.param2.$newPilotTemplate" />
            <do_if value="@event.param2.$newPilot != null">
              <set_value name="$newPilotTemplate" exact="@event.param2.$newPilot.npctemplate" />
            </do_if>
            <set_value name="$academyObject" exact="@event.param2.$academyObject" />
            <set_value name="$newPilotName" exact="$academyObject.availablepeople.{$newPilotTemplate}.name" />
            <set_value name="$iteration" exact="@event.param2.$iteration" />
            <set_value name="$shipFreeCapacity" exact="$ship.people.free" />
            <debug_text
              text="'Pilot Academy: Process_Move_New_Pilot: Iteration %s. Going to move new pilot %s (%s) to %s. Free capacity: %s.' .
                  [$iteration, $newPilotName, $newPilotTemplate, $shipName, $shipFreeCapacity]"
              chance="$debugchance" />
            <do_if value="$shipFreeCapacity gt 0">
              <transfer_people result="$personTransferred" object="$ship" otherobject="$academyObject"
                receiveworkforce="false">
                <existing_people people="[$newPilotTemplate]" />
              </transfer_people>
              <do_if value="$personTransferred.count == 1">
                <debug_text
                  text="'Pilot Academy: Process_Move_New_Pilot: new pilot %s (%s) successfully transferred to %s. Initiating pilot swap.' .
                      [$newPilotName, $newPilotTemplate, $ship.debugname]"
                  chance="$debugchance" />
                <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,1000005}.[$shipName, $newPilotName]]" timeout="15s" />
                <signal_objects object="player.entity" param="'AcademyPilotSwapRequest'"
                  param2="table[
                    $ship = $ship,
                    $replacementPilotTemplate = $personTransferred.{1},
                    $academyObject = $academyObject,
                    $iteration = 0
                  ]"
                  delay="200ms" />
              </do_if>
              <do_else>
                <do_if value="$iteration le 5">
                  <debug_text
                    text="'Pilot Academy: Process_Move_New_Pilot: failed to transfer new pilot %s (%s) to %s. Going to repeat.' .
                      [$newPilotName, $newPilotTemplate, $shipName]"
                    chance="$debugchance" />
                  <signal_objects object="player.entity" param="'AcademyMoveNewPilotRequest'"
                    param2="table[
                    $newPilotTemplate = $newPilotTemplate,
                    $ship = $ship,
                    $academyObject = $academyObject,
                    $iteration = $iteration + 1
                  ]"
                    delay="500ms" />
                </do_if>
                <do_else>
                  <debug_text
                    text="'Pilot Academy: Process_Move_New_Pilot: exceeded max attempts to transfer new pilot %s (%s) to %s. Please do it manually!' .
                          [$newPilotName, $newPilotTemplate, $ship.debugname]"
                    chance="$debugchance" />
                  <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,2000006}.[$shipName, $newPilotName]]" priority="2" sound="notification_warning"
                    timeout="15s" />
                </do_else>
              </do_else>
            </do_if>
            <do_else>
              <debug_text
                text="'Pilot Academy: Process_Move_New_Pilot: no free capacity on ship %s to move new pilot %s (%s).' .
                  [$ship.debugname, $newPilotName, $newPilotTemplate]"
                chance="$debugchance" />
              <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,2000002}.[$shipName]]" priority="2" sound="notification_warning"
                timeout="15s" />
            </do_else>
            <remove_value name="$iteration" />
            <remove_value name="$newPilotName" />
            <remove_value name="$newPilotTemplate" />
            <remove_value name="$ship" />
            <remove_value name="$shipName" />
            <remove_value name="$academyObject" />
            <remove_value name="$personTransferred" />
          </actions>
        </cue>


        <cue name="Process_No_Cadets_Available" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'AcademyNoCadetsAvailable'" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_No_Cadets_Available: No cadets available in Academy.'"
              chance="$debugchance" filter="scripts" />
            <show_notification text="'%s\n%s'.[{1972092412,1}, {1972092412,2000001}]" priority="2" sound="notification_warning"
              timeout="15s" />
          </actions>
        </cue>

        <cue name="Process_Pilot_Auto_Hire" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'AcademyCadetAutoHire'" />
          </conditions>
          <actions>
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Received auto-hire request. At: %s (%s). Factions: %s.' .
                [@event.param2.debugname, @event.param2, @event.param3]"
              chance="$debugchance" filter="scripts" />
            <set_value name="$ship" exact="@event.param2" />
            <set_value name="$factionNames" exact="@event.param3" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Ship is %s. Faction names filter: %s.' .
                [$ship.debugname, $factionNames]"
              chance="$debugchance" />
            <get_factions_by_relation faction="faction.player" relation="neutral" result="$factionsListAll" />
            <get_factions_by_relation faction="faction.player" relation="friend" result="$friendFactions" />
            <append_list_elements name="$factionsListAll" other="$friendFactions" />
            <get_factions_by_tag result="$hiddenFactions" tag="tag.hidden" />
            <remove_from_list name="$factionsListAll" list="$hiddenFactions" />
            <remove_from_list name="$factionsListAll" exact="faction.player" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Factions available after relation and hidden filtering: %s, count: %s.' .
                [@$factionsListAll, @$factionsListAll.count]"
              chance="$debugchance" />
            <create_list name="$factionsListFiltered" />
            <do_if value="@$factionNames != null and $factionNames.count gt 0">
              <do_for_each name="$faction" in="$factionsListAll">
                <do_if value="$factionNames.indexof.{$faction.id} gt 0">
                  <append_to_list name="$factionsListFiltered" exact="$faction" />
                </do_if>
              </do_for_each>
            </do_if>
            <do_else>
              <append_list_elements name="$factionsListFiltered" other="$factionsListAll" />
            </do_else>
            <shuffle_list list="$factionsListFiltered" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Factions available after name filtering: %s, count: %s, first: %s.' .
                [@$factionsListFiltered, @$factionsListFiltered.count, @$factionsListFiltered.{1}]"
              chance="$debugchance" />
            <set_value name="$selectedFaction" exact="$factionsListFiltered.{1}" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Selected faction %s for new cadet on %s.' .
                [$selectedFaction.id, $ship.debugname]"
              chance="$debugchance" />
            <get_character_definition macro="$cadetMacro" faction="$selectedFaction" tags="tag.pilot" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Cadet macro is %s.' .
                [@$cadetMacro]"
              chance="$debugchance" />
            <create_npc_template object="$ship" role="entityrole.trainee_group" name="$cadetTemplate" macro="$cadetMacro" />
            <set_skill object="$ship" template="$cadetTemplate" type="skilltype.boarding" min="0" max="2" />
            <set_skill object="$ship" template="$cadetTemplate" type="skilltype.engineering" min="1" max="4" />
            <set_skill object="$ship" template="$cadetTemplate" type="skilltype.management" min="1" max="2" />
            <set_skill object="$ship" template="$cadetTemplate" type="skilltype.piloting" min="2" max="4" />
            <set_skill object="$ship" template="$cadetTemplate" type="skilltype.morale" min="2" max="4" />
            <set_value name="$combinedskill" exact="$ship.availablepeople.{$cadetTemplate}.potentialskill.{controlpost.aipilot}" />
            <run_actions ref="md.NPC_Instantiation.HiringFeeFromCombinedSkill" result="$cadetHiringFee">
              <param name="combinedskill" value="$combinedskill" />
            </run_actions>
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Created new cadet %s (%s) on %s with hiring fee %s.' .
                [@$ship.availablepeople.{$cadetTemplate}.name, @$cadetTemplate, $ship.debugname, @$cadetHiringFee]"
              chance="$debugchance" />
            <reward_player money="-$cadetHiringFee" />
            <show_notification
              text="'%s\n%s'.[{1972092412,1}, {1972092412,1000004}.[@$ship.availablepeople.{$cadetTemplate}.name, @$cadetHiringFee.formatted.default]]"
              timeout="15s" />
            <set_value name="$commonData" exact="@player.entity.$pilotAcademyRAndRData" />
            <set_value name="$academyObject" exact="$commonData.$locationObject" />
            <debug_text
              text="'Pilot Academy: Process_Pilot_Auto_Hire: Academy object is %s.' .
                [$academyObject.debugname]"
              chance="$debugchance" />
            <signal_objects object="player.entity" param="'AcademyPilotSwapRequest'"
              param2="table[
                $ship = $ship,
                $replacementPilotTemplate = $cadetTemplate,
                $academyObject = $academyObject,
                $iteration = 0
              ]"
              delay="200ms" />
            <remove_value name="$cadetHiringFee" />
            <remove_value name="$cadetTemplate" />
            <remove_value name="$cadetMacro" />
            <remove_value name="$selectedFaction" />
            <remove_value name="$factionsListFiltered" />
            <remove_value name="$factionNames" />
            <remove_value name="$friendFactions" />
            <remove_value name="$factionsListAll" />
            <remove_value name="$academyObject" />
            <remove_value name="$combinedskill" />
            <remove_value name="$ship" />
          </actions>
        </cue>

      </cues>
    </cue>
  </cues>
</mdscript>